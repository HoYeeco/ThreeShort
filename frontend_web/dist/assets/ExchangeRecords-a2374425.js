import{E as I,I as $,J as re,H as ue,z as de}from"./element-a02f8ecb.js";import{u as ie,r as A}from"./index-3d03330f.js";import{x as ce,r as v,h as pe,k as _e,z as E,A as u,O as n,u as m,L as f,H as h,I as t,Q as e,ag as d,aq as me,y as c,M as r,J as ve}from"./vendor-0e940c15.js";import{_ as fe}from"./_plugin-vue_export-helper-c27b6911.js";const ge={class:"exchange-records-container"},ye={class:"page-header"},we={class:"header-left"},xe={key:0,class:"total-info"},he={class:"total-exchanges"},be={class:"total-points"},ke={class:"header-right"},Ce={key:0,class:"stats-cards"},Ie={class:"stat-item"},Se={class:"stat-value"},De={class:"stat-item"},Ee={class:"stat-value"},Pe={class:"stat-item"},Te={class:"stat-value"},Ve={class:"stat-item"},Ue={class:"stat-value"},Ae={key:0},Ne={key:1,class:"no-remarks"},ze={class:"pagination"},Le={class:"card-header"},Me={key:0,class:"record-details"},Re={class:"dialog-footer"},Ye=ce({__name:"ExchangeRecords",setup(Be){const i=ie(),M=v([]),g=v(null),N=v([]),_=v(null),o=v({userId:null,productName:"",status:"",minPoints:null,maxPoints:null,startTime:null,endTime:null}),T=v(null),y=v({current:1,size:20,total:0}),V=v(!1),P=v(!1),Q=v(!1);pe(T,l=>{l&&l.length===2?(o.value.startTime=l[0],o.value.endTime=l[1]):(o.value.startTime=null,o.value.endTime=null)});const S=async()=>{var l;P.value=!0;try{const a={current:y.value.current,size:y.value.size,...o.value};!i.isAdmin&&((l=i.userInfo)!=null&&l.id)&&(a.userId=i.userInfo.id);const b=await A.get("/exchange-record/list",{params:a});M.value=b.data.records||[],y.value.total=b.data.total||0}catch{I.error("加载兑换记录失败")}finally{P.value=!1}},R=async()=>{if(i.isAdmin)try{const l=await A.get("/exchange-record/statistics");g.value=l.data}catch{I.error("加载统计数据失败")}},Y=async()=>{if(i.isAdmin)try{const l=await A.get("/exchange-record/popular-products?limit=10");N.value=l.data||[]}catch{I.error("加载热门商品失败")}},J=()=>{o.value={userId:null,productName:"",status:"",minPoints:null,maxPoints:null,startTime:null,endTime:null},T.value=null,y.value.current=1,S()},j=l=>{_.value=l,V.value=!0},O=async l=>{try{await de.confirm(`确定要删除记录ID为"${l.id}"的兑换记录吗？`,"提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),await A.delete(`/exchange-record/delete/${l.id}`),I.success("删除成功"),S()}catch(a){a!=="cancel"&&I.error("删除失败")}},G=async()=>{try{P.value=!0;const l=new URLSearchParams;o.value.userId&&l.append("userId",o.value.userId.toString()),o.value.productName&&l.append("productName",o.value.productName),o.value.status&&l.append("status",o.value.status),o.value.minPoints&&l.append("minPoints",o.value.minPoints.toString()),o.value.maxPoints&&l.append("maxPoints",o.value.maxPoints.toString()),o.value.startTime&&l.append("startTime",o.value.startTime),o.value.endTime&&l.append("endTime",o.value.endTime);const a=`/api/exchange-record/export?${l.toString()}`;window.open(a,"_blank"),I.success("导出请求已发送，请稍候下载")}catch(l){console.error("导出失败:",l),I.error("导出失败，请重试")}finally{P.value=!1}},B=l=>({SUCCESS:"success",FAILED:"danger",CANCELLED:"warning"})[l]||"info",q=l=>({SUCCESS:"成功",FAILED:"失败",CANCELLED:"已取消"})[l]||l,F=l=>new Date(l).toLocaleString("zh-CN"),K=l=>l>=1e4?(l/1e4).toFixed(1)+"w":l>=1e3?(l/1e3).toFixed(1)+"k":(l==null?void 0:l.toString())||"0";return _e(()=>{S(),i.isAdmin&&(R(),Y())}),(l,a)=>{const b=d("el-icon"),x=d("el-button"),W=d("el-input"),D=d("el-form-item"),z=d("el-input-number"),L=d("el-option"),X=d("el-select"),Z=d("el-date-picker"),ee=d("el-form"),k=d("el-card"),U=d("el-col"),te=d("el-row"),p=d("el-table-column"),C=d("el-tag"),H=d("el-table"),ae=d("el-pagination"),w=d("el-descriptions-item"),le=d("el-descriptions"),se=d("el-dialog"),oe=me("loading");return c(),E("div",ge,[u("div",ye,[u("div",we,[u("h2",null,n(m(i).isAdmin?"兑换记录管理":"我的兑换记录"),1),g.value?(c(),E("div",xe,[u("span",he,"总兑换次数："+n(g.value.totalExchanges||0),1),u("span",be,"累计消耗："+n(g.value.totalPointsUsed||0)+" 积分",1)])):f("",!0)]),u("div",ke,[m(i).isAdmin?(c(),h(x,{key:0,type:"primary",onClick:R},{default:t(()=>[e(b,null,{default:t(()=>[e(m($))]),_:1}),a[10]||(a[10]=r(" 刷新统计 "))]),_:1,__:[10]})):f("",!0),e(x,{type:"success",onClick:G,loading:Q.value},{default:t(()=>[e(b,null,{default:t(()=>[e(m(re))]),_:1}),a[11]||(a[11]=r(" 导出记录 "))]),_:1,__:[11]},8,["loading"])])]),e(k,{class:"filter-card",shadow:"never"},{default:t(()=>[e(ee,{model:o.value,inline:""},{default:t(()=>[m(i).isAdmin?(c(),h(D,{key:0,label:"商品名称"},{default:t(()=>[e(W,{modelValue:o.value.productName,"onUpdate:modelValue":a[0]||(a[0]=s=>o.value.productName=s),placeholder:"请输入商品名称",clearable:"",style:{width:"200px"}},null,8,["modelValue"])]),_:1})):f("",!0),m(i).isAdmin?(c(),h(D,{key:1,label:"用户ID"},{default:t(()=>[e(z,{modelValue:o.value.userId,"onUpdate:modelValue":a[1]||(a[1]=s=>o.value.userId=s),placeholder:"用户ID",min:0,style:{width:"150px"}},null,8,["modelValue"])]),_:1})):f("",!0),e(D,{label:"兑换状态"},{default:t(()=>[e(X,{modelValue:o.value.status,"onUpdate:modelValue":a[2]||(a[2]=s=>o.value.status=s),placeholder:"请选择状态",clearable:"",style:{width:"120px"}},{default:t(()=>[e(L,{label:"成功",value:"SUCCESS"}),e(L,{label:"失败",value:"FAILED"}),e(L,{label:"已取消",value:"CANCELLED"})]),_:1},8,["modelValue"])]),_:1}),e(D,{label:"时间范围"},{default:t(()=>[e(Z,{modelValue:T.value,"onUpdate:modelValue":a[3]||(a[3]=s=>T.value=s),type:"datetimerange","range-separator":"至","start-placeholder":"开始时间","end-placeholder":"结束时间",format:"YYYY-MM-DD HH:mm:ss","value-format":"YYYY-MM-DD HH:mm:ss",style:{width:"350px"}},null,8,["modelValue"])]),_:1}),e(D,{label:"积分范围"},{default:t(()=>[e(z,{modelValue:o.value.minPoints,"onUpdate:modelValue":a[4]||(a[4]=s=>o.value.minPoints=s),placeholder:"最小积分",min:0,style:{width:"120px"}},null,8,["modelValue"]),a[12]||(a[12]=u("span",{style:{margin:"0 10px"}},"-",-1)),e(z,{modelValue:o.value.maxPoints,"onUpdate:modelValue":a[5]||(a[5]=s=>o.value.maxPoints=s),placeholder:"最大积分",min:0,style:{width:"120px"}},null,8,["modelValue"])]),_:1,__:[12]}),e(D,null,{default:t(()=>[e(x,{type:"primary",onClick:S},{default:t(()=>[e(b,null,{default:t(()=>[e(m(ue))]),_:1}),a[13]||(a[13]=r(" 搜索 "))]),_:1,__:[13]}),e(x,{onClick:J},{default:t(()=>[e(b,null,{default:t(()=>[e(m($))]),_:1}),a[14]||(a[14]=r(" 重置 "))]),_:1,__:[14]})]),_:1})]),_:1},8,["model"])]),_:1}),m(i).isAdmin&&g.value?(c(),E("div",Ce,[e(te,{gutter:20},{default:t(()=>[e(U,{span:6},{default:t(()=>[e(k,{class:"stat-card"},{default:t(()=>[u("div",Ie,[u("div",Se,n(g.value.totalExchanges||0),1),a[15]||(a[15]=u("div",{class:"stat-label"},"总兑换数",-1))])]),_:1})]),_:1}),e(U,{span:6},{default:t(()=>[e(k,{class:"stat-card"},{default:t(()=>[u("div",De,[u("div",Ee,n(g.value.successExchanges||0),1),a[16]||(a[16]=u("div",{class:"stat-label"},"成功兑换",-1))])]),_:1})]),_:1}),e(U,{span:6},{default:t(()=>[e(k,{class:"stat-card"},{default:t(()=>[u("div",Pe,[u("div",Te,n(g.value.todayExchanges||0),1),a[17]||(a[17]=u("div",{class:"stat-label"},"今日兑换",-1))])]),_:1})]),_:1}),e(U,{span:6},{default:t(()=>[e(k,{class:"stat-card"},{default:t(()=>[u("div",Ve,[u("div",Ue,n(K(g.value.totalPointsUsed)),1),a[18]||(a[18]=u("div",{class:"stat-label"},"累计积分",-1))])]),_:1})]),_:1})]),_:1})])):f("",!0),e(k,{class:"table-card"},{default:t(()=>[ve((c(),h(H,{data:M.value,style:{width:"100%"},"row-key":"id"},{default:t(()=>[e(p,{prop:"id",label:"记录ID",width:"100",align:"center"}),m(i).isAdmin?(c(),h(p,{key:0,prop:"userId",label:"用户ID",width:"100",align:"center"})):f("",!0),e(p,{prop:"productName",label:"商品名称","min-width":"150"}),e(p,{prop:"quantity",label:"兑换数量",width:"100",align:"center"},{default:t(s=>[e(C,{type:"info"},{default:t(()=>[r(n(s.row.quantity),1)]),_:2},1024)]),_:1}),e(p,{prop:"pointsUsed",label:"消耗积分",width:"120",align:"center"},{default:t(s=>[e(C,{type:"warning"},{default:t(()=>[r(n(s.row.pointsUsed),1)]),_:2},1024)]),_:1}),e(p,{prop:"status",label:"兑换状态",width:"100",align:"center"},{default:t(s=>[e(C,{type:B(s.row.status)},{default:t(()=>[r(n(q(s.row.status)),1)]),_:2},1032,["type"])]),_:1}),e(p,{prop:"exchangeTime",label:"兑换时间",width:"160"},{default:t(s=>[r(n(F(s.row.exchangeTime)),1)]),_:1}),e(p,{prop:"remarks",label:"备注","min-width":"120"},{default:t(s=>[s.row.remarks?(c(),E("span",Ae,n(s.row.remarks),1)):(c(),E("span",Ne,"-"))]),_:1}),m(i).isAdmin?(c(),h(p,{key:1,label:"操作",width:"120",fixed:"right"},{default:t(s=>[e(x,{type:"primary",size:"small",onClick:ne=>j(s.row)},{default:t(()=>a[19]||(a[19]=[r(" 详情 ")])),_:2,__:[19]},1032,["onClick"]),s.row.status!=="SUCCESS"?(c(),h(x,{key:0,type:"danger",size:"small",onClick:ne=>O(s.row)},{default:t(()=>a[20]||(a[20]=[r(" 删除 ")])),_:2,__:[20]},1032,["onClick"])):f("",!0)]),_:1})):f("",!0)]),_:1},8,["data"])),[[oe,P.value]]),u("div",ze,[e(ae,{"current-page":y.value.current,"onUpdate:currentPage":a[6]||(a[6]=s=>y.value.current=s),"page-size":y.value.size,"onUpdate:pageSize":a[7]||(a[7]=s=>y.value.size=s),"page-sizes":[10,20,50,100],total:y.value.total,layout:"total, sizes, prev, pager, next, jumper",onSizeChange:S,onCurrentChange:S},null,8,["current-page","page-size","total"])])]),_:1}),m(i).isAdmin&&N.value.length>0?(c(),h(k,{key:1,class:"popular-products"},{header:t(()=>[u("div",Le,[a[22]||(a[22]=u("span",null,"热门商品统计",-1)),e(x,{type:"text",onClick:Y},{default:t(()=>a[21]||(a[21]=[r("刷新")])),_:1,__:[21]})])]),default:t(()=>[e(H,{data:N.value,style:{width:"100%"}},{default:t(()=>[e(p,{prop:"productName",label:"商品名称","min-width":"150"}),e(p,{prop:"totalQuantity",label:"兑换总量",width:"120",align:"center"},{default:t(s=>[e(C,{type:"success"},{default:t(()=>[r(n(s.row.totalQuantity),1)]),_:2},1024)]),_:1}),e(p,{prop:"exchangeCount",label:"兑换次数",width:"120",align:"center"},{default:t(s=>[e(C,{type:"primary"},{default:t(()=>[r(n(s.row.exchangeCount),1)]),_:2},1024)]),_:1}),e(p,{prop:"totalPoints",label:"消耗积分",width:"120",align:"center"},{default:t(s=>[e(C,{type:"warning"},{default:t(()=>[r(n(s.row.totalPoints),1)]),_:2},1024)]),_:1})]),_:1},8,["data"])]),_:1})):f("",!0),e(se,{modelValue:V.value,"onUpdate:modelValue":a[9]||(a[9]=s=>V.value=s),title:"兑换详情",width:"600px"},{footer:t(()=>[u("span",Re,[e(x,{onClick:a[8]||(a[8]=s=>V.value=!1)},{default:t(()=>a[23]||(a[23]=[r("关闭")])),_:1,__:[23]})])]),default:t(()=>[_.value?(c(),E("div",Me,[e(le,{column:2,border:""},{default:t(()=>[e(w,{label:"记录ID"},{default:t(()=>[r(n(_.value.id),1)]),_:1}),e(w,{label:"用户ID"},{default:t(()=>[r(n(_.value.userId),1)]),_:1}),e(w,{label:"商品ID"},{default:t(()=>[r(n(_.value.productId),1)]),_:1}),e(w,{label:"商品名称"},{default:t(()=>[r(n(_.value.productName),1)]),_:1}),e(w,{label:"兑换数量"},{default:t(()=>[r(n(_.value.quantity),1)]),_:1}),e(w,{label:"消耗积分"},{default:t(()=>[r(n(_.value.pointsUsed),1)]),_:1}),e(w,{label:"兑换状态"},{default:t(()=>[e(C,{type:B(_.value.status)},{default:t(()=>[r(n(q(_.value.status)),1)]),_:1},8,["type"])]),_:1}),e(w,{label:"兑换时间"},{default:t(()=>[r(n(F(_.value.exchangeTime)),1)]),_:1}),e(w,{label:"备注",span:2},{default:t(()=>[r(n(_.value.remarks||"无备注"),1)]),_:1})]),_:1})])):f("",!0)]),_:1},8,["modelValue"])])}}});const Qe=fe(Ye,[["__scopeId","data-v-81bcc3ce"]]);export{Qe as default};
