import{u as fe}from"./index-3d03330f.js";import{E as c,z as ge}from"./element-a02f8ecb.js";import{x as ve,r as p,X as D,k as _e,z as ce,Q as e,I as t,ag as f,aq as we,y as O,A as V,M as i,J as be,H as ye,O as E}from"./vendor-0e940c15.js";import{_ as Ve}from"./_plugin-vue_export-helper-c27b6911.js";const Ce={class:"users-container"},Ne={class:"pagination-container"},xe={class:"dialog-footer"},ke={class:"dialog-footer"},Ue={class:"dialog-footer"},Re=ve({__name:"Users",setup(Ie){const C=fe(),T=p(!1),z=p(!1),M=p(!1),S=p(!1),N=p(!1),x=p(!1),k=p(!1),R=p([]),q=p(0),n=p(null),u=D({page:1,size:10,keyword:"",role:void 0,status:void 0}),s=D({id:0,username:"",realName:"",phone:"",idCard:"",address:""}),g=D({newPassword:"",confirmPassword:""}),v=D({role:""}),U=p(),I=p(),P=p(),Q=(a,l,r)=>{l!==g.newPassword?r(new Error("两次输入的密码不一致")):r()},X={realName:[{required:!0,message:"请输入真实姓名",trigger:"blur"},{max:50,message:"真实姓名长度不能超过50个字符",trigger:"blur"}],phone:[{required:!0,message:"请输入手机号",trigger:"blur"},{pattern:/^1[3-9]\d{9}$/,message:"手机号格式不正确",trigger:"blur"}],idCard:[{required:!0,message:"请输入身份证号",trigger:"blur"},{pattern:/^[1-9]\d{5}(18|19|20)\d{2}((0[1-9])|(1[0-2]))(([0-2][1-9])|10|20|30|31)\d{3}[0-9Xx]$/,message:"身份证号格式不正确",trigger:"blur"}]},H={newPassword:[{required:!0,message:"请输入新密码",trigger:"blur"},{min:6,message:"密码长度不能少于6位",trigger:"blur"}],confirmPassword:[{required:!0,message:"请确认密码",trigger:"blur"},{validator:Q,trigger:"blur"}]},J={role:[{required:!0,message:"请选择角色",trigger:"change"}]},B=p("编辑用户"),L=a=>({RESIDENT:"居民",ADMIN:"管理员",MAINTAINER:"维护员"})[a]||a,j=a=>({RESIDENT:"info",ADMIN:"warning",MAINTAINER:"success"})[a]||"info",b=async()=>{T.value=!0;try{const a=await C.fetchUserList(u);R.value=a.records,q.value=a.total}catch(a){c.error(a.message||"加载用户列表失败")}finally{T.value=!1}},G=()=>{u.page=1,b()},K=a=>{u.size=a,u.page=1,b()},W=a=>{u.page=a,b()},Y=()=>{Object.assign(u,{page:1,size:10,keyword:"",role:void 0,status:void 0}),b()},Z=a=>{n.value=a,B.value="编辑用户",Object.assign(s,{id:a.id,username:a.username,realName:a.realName,phone:a.phone,idCard:a.idCard,address:a.address}),N.value=!0},ee=async a=>{const l=a.status===1?"禁用":"启用",r=a.status===1?0:1;try{await ge.confirm(`确定要${l}用户 ${a.realName} 吗？`,"提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),await C.updateUserStatus(a.id,r),a.status=r,c.success(`${l}成功`)}catch{}},le=a=>{n.value=a,g.newPassword="",g.confirmPassword="",x.value=!0},ae=async()=>{if(U.value)try{await U.value.validate(),z.value=!0;const a={realName:s.realName,phone:s.phone,idCard:s.idCard,address:s.address};await C.updateUserInfoByAdmin(s.id,a),c.success("更新成功"),N.value=!1,b()}catch(a){if(a.fields)return;c.error(a.message||"更新失败")}finally{z.value=!1}},oe=async()=>{if(!(!I.value||!n.value))try{await I.value.validate(),M.value=!0,await C.resetUserPassword(n.value.id,g.newPassword),c.success("密码重置成功"),x.value=!1}catch(a){if(a.fields)return;c.error(a.message||"密码重置失败")}finally{M.value=!1}},te=()=>{U.value&&U.value.resetFields(),n.value=null},se=()=>{var a;g.newPassword="",g.confirmPassword="",(a=I.value)==null||a.clearValidate()},re=()=>{var a;v.role="",(a=P.value)==null||a.clearValidate()},de=a=>{n.value=a,v.role=a.role,k.value=!0},ne=async()=>{if(!(!P.value||!n.value))try{if(await P.value.validate(),v.role===n.value.role){c.warning("新角色与当前角色相同");return}S.value=!0,await C.updateUserRole(n.value.id,v.role),n.value.role=v.role;const a=R.value.findIndex(l=>l.id===n.value.id);a!==-1&&(R.value[a].role=v.role),c.success("角色分配成功"),k.value=!1}catch(a){c.error(a.message||"角色分配失败")}finally{S.value=!1}};return _e(()=>{b()}),(a,l)=>{const r=f("el-input"),d=f("el-form-item"),w=f("el-option"),A=f("el-select"),m=f("el-button"),h=f("el-form"),_=f("el-table-column"),F=f("el-tag"),ue=f("el-table"),ie=f("el-pagination"),pe=f("el-card"),$=f("el-dialog"),me=we("loading");return O(),ce("div",Ce,[e(pe,null,{header:t(()=>l[17]||(l[17]=[V("div",{class:"card-header"},[V("span",null,"用户管理")],-1)])),default:t(()=>[e(h,{model:u,inline:!0,class:"query-form"},{default:t(()=>[e(d,{label:"关键词"},{default:t(()=>[e(r,{modelValue:u.keyword,"onUpdate:modelValue":l[0]||(l[0]=o=>u.keyword=o),placeholder:"用户名/真实姓名",clearable:"",style:{width:"200px"}},null,8,["modelValue"])]),_:1}),e(d,{label:"用户角色"},{default:t(()=>[e(A,{modelValue:u.role,"onUpdate:modelValue":l[1]||(l[1]=o=>u.role=o),placeholder:"请选择",clearable:"",style:{width:"150px"}},{default:t(()=>[e(w,{label:"居民",value:"RESIDENT"}),e(w,{label:"管理员",value:"ADMIN"}),e(w,{label:"维护员",value:"MAINTAINER"})]),_:1},8,["modelValue"])]),_:1}),e(d,{label:"状态"},{default:t(()=>[e(A,{modelValue:u.status,"onUpdate:modelValue":l[2]||(l[2]=o=>u.status=o),placeholder:"请选择",clearable:"",style:{width:"120px"}},{default:t(()=>[e(w,{label:"启用",value:1}),e(w,{label:"禁用",value:0})]),_:1},8,["modelValue"])]),_:1}),e(d,null,{default:t(()=>[e(m,{type:"primary",onClick:G},{default:t(()=>l[18]||(l[18]=[i("查询")])),_:1,__:[18]}),e(m,{onClick:Y},{default:t(()=>l[19]||(l[19]=[i("重置")])),_:1,__:[19]})]),_:1})]),_:1},8,["model"]),be((O(),ye(ue,{data:R.value,border:"",stripe:""},{default:t(()=>[e(_,{prop:"id",label:"ID",width:"80"}),e(_,{prop:"username",label:"用户名",width:"120"}),e(_,{prop:"realName",label:"真实姓名",width:"120"}),e(_,{prop:"phone",label:"手机号",width:"130"}),e(_,{prop:"role",label:"角色",width:"100"},{default:t(({row:o})=>[e(F,{type:j(o.role)},{default:t(()=>[i(E(L(o.role)),1)]),_:2},1032,["type"])]),_:1}),e(_,{prop:"status",label:"状态",width:"80"},{default:t(({row:o})=>[e(F,{type:o.status===1?"success":"danger"},{default:t(()=>[i(E(o.status===1?"启用":"禁用"),1)]),_:2},1032,["type"])]),_:1}),e(_,{prop:"address",label:"住址","show-overflow-tooltip":""}),e(_,{prop:"createdTime",label:"创建时间",width:"180"}),e(_,{label:"操作",width:"360",fixed:"right"},{default:t(({row:o})=>[e(m,{type:"warning",size:"small",onClick:y=>Z(o)},{default:t(()=>l[20]||(l[20]=[i(" 编辑 ")])),_:2,__:[20]},1032,["onClick"]),e(m,{type:o.status===1?"danger":"success",size:"small",onClick:y=>ee(o)},{default:t(()=>[i(E(o.status===1?"禁用":"启用"),1)]),_:2},1032,["type","onClick"]),e(m,{type:"info",size:"small",onClick:y=>le(o)},{default:t(()=>l[21]||(l[21]=[i(" 重置密码 ")])),_:2,__:[21]},1032,["onClick"]),e(m,{type:"primary",size:"small",onClick:y=>de(o)},{default:t(()=>l[22]||(l[22]=[i(" 分配角色 ")])),_:2,__:[22]},1032,["onClick"])]),_:1})]),_:1},8,["data"])),[[me,T.value]]),V("div",Ne,[e(ie,{"current-page":u.page,"page-size":u.size,total:q.value,"page-sizes":[10,20,50,100],layout:"total, sizes, prev, pager, next, jumper",onSizeChange:K,onCurrentChange:W},null,8,["current-page","page-size","total"])])]),_:1}),e($,{modelValue:N.value,"onUpdate:modelValue":l[9]||(l[9]=o=>N.value=o),title:B.value,width:"600px",onClose:te},{footer:t(()=>[V("span",xe,[e(m,{onClick:l[8]||(l[8]=o=>N.value=!1)},{default:t(()=>l[23]||(l[23]=[i("取消")])),_:1,__:[23]}),e(m,{type:"primary",loading:z.value,onClick:ae},{default:t(()=>l[24]||(l[24]=[i(" 确定 ")])),_:1,__:[24]},8,["loading"])])]),default:t(()=>[e(h,{ref_key:"editFormRef",ref:U,model:s,rules:X,"label-width":"100px"},{default:t(()=>[e(d,{label:"用户名",prop:"username"},{default:t(()=>[e(r,{modelValue:s.username,"onUpdate:modelValue":l[3]||(l[3]=o=>s.username=o),disabled:""},null,8,["modelValue"])]),_:1}),e(d,{label:"真实姓名",prop:"realName"},{default:t(()=>[e(r,{modelValue:s.realName,"onUpdate:modelValue":l[4]||(l[4]=o=>s.realName=o),placeholder:"请输入真实姓名"},null,8,["modelValue"])]),_:1}),e(d,{label:"手机号",prop:"phone"},{default:t(()=>[e(r,{modelValue:s.phone,"onUpdate:modelValue":l[5]||(l[5]=o=>s.phone=o),placeholder:"请输入手机号"},null,8,["modelValue"])]),_:1}),e(d,{label:"身份证号",prop:"idCard"},{default:t(()=>[e(r,{modelValue:s.idCard,"onUpdate:modelValue":l[6]||(l[6]=o=>s.idCard=o),placeholder:"请输入身份证号"},null,8,["modelValue"])]),_:1}),e(d,{label:"住址",prop:"address"},{default:t(()=>[e(r,{modelValue:s.address,"onUpdate:modelValue":l[7]||(l[7]=o=>s.address=o),placeholder:"请输入住址",type:"textarea",rows:3},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"]),e($,{modelValue:x.value,"onUpdate:modelValue":l[13]||(l[13]=o=>x.value=o),title:"重置密码",width:"400px",onClose:se},{footer:t(()=>[V("span",ke,[e(m,{onClick:l[12]||(l[12]=o=>x.value=!1)},{default:t(()=>l[25]||(l[25]=[i("取消")])),_:1,__:[25]}),e(m,{type:"primary",loading:M.value,onClick:oe},{default:t(()=>l[26]||(l[26]=[i(" 确定重置 ")])),_:1,__:[26]},8,["loading"])])]),default:t(()=>[e(h,{ref_key:"passwordFormRef",ref:I,model:g,rules:H,"label-width":"100px"},{default:t(()=>[e(d,{label:"用户"},{default:t(()=>{var o;return[e(r,{value:(o=n.value)==null?void 0:o.realName,disabled:""},null,8,["value"])]}),_:1}),e(d,{label:"新密码",prop:"newPassword"},{default:t(()=>[e(r,{modelValue:g.newPassword,"onUpdate:modelValue":l[10]||(l[10]=o=>g.newPassword=o),type:"password",placeholder:"请输入新密码（6位以上）","show-password":""},null,8,["modelValue"])]),_:1}),e(d,{label:"确认密码",prop:"confirmPassword"},{default:t(()=>[e(r,{modelValue:g.confirmPassword,"onUpdate:modelValue":l[11]||(l[11]=o=>g.confirmPassword=o),type:"password",placeholder:"请再次输入新密码","show-password":""},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),e($,{modelValue:k.value,"onUpdate:modelValue":l[16]||(l[16]=o=>k.value=o),title:"分配角色",width:"400px",onClose:re},{footer:t(()=>[V("span",Ue,[e(m,{onClick:l[15]||(l[15]=o=>k.value=!1)},{default:t(()=>l[27]||(l[27]=[i("取消")])),_:1,__:[27]}),e(m,{type:"primary",loading:S.value,onClick:ne},{default:t(()=>l[28]||(l[28]=[i(" 确定分配 ")])),_:1,__:[28]},8,["loading"])])]),default:t(()=>[e(h,{ref_key:"roleFormRef",ref:P,model:v,rules:J,"label-width":"100px"},{default:t(()=>[e(d,{label:"用户"},{default:t(()=>{var o;return[e(r,{value:(o=n.value)==null?void 0:o.realName,disabled:""},null,8,["value"])]}),_:1}),e(d,{label:"当前角色"},{default:t(()=>{var o;return[e(F,{type:j(((o=n.value)==null?void 0:o.role)||"")},{default:t(()=>{var y;return[i(E(L(((y=n.value)==null?void 0:y.role)||"")),1)]}),_:1},8,["type"])]}),_:1}),e(d,{label:"新角色",prop:"role"},{default:t(()=>[e(A,{modelValue:v.role,"onUpdate:modelValue":l[14]||(l[14]=o=>v.role=o),placeholder:"请选择角色",style:{width:"100%"}},{default:t(()=>[e(w,{label:"普通居民",value:"RESIDENT"}),e(w,{label:"社区管理员",value:"ADMIN"}),e(w,{label:"系统维护人员",value:"MAINTAINER"})]),_:1},8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])}}});const Te=Ve(Re,[["__scopeId","data-v-8d27cd47"]]);export{Te as default};
