import{E as _,G as te,z as Te}from"./element-a02f8ecb.js";import{u as Ee,r as R}from"./index-3d03330f.js";import{x as Re,r as k,X as M,c as ae,k as Ae,z as P,Q as l,I as t,ag as u,aq as xe,y as n,A as m,u as N,H as p,M as r,L as b,P as U,a4 as h,J as ze,O as v}from"./vendor-0e940c15.js";import{_ as Ne}from"./_plugin-vue_export-helper-c27b6911.js";const Ue={class:"credit-reports-container"},he={class:"card-header"},Fe={class:"search-form"},Me={class:"pagination"},Se={class:"dialog-footer"},Be={key:0,class:"report-content"},$e={class:"evidence-images"},Oe={class:"review-form"},We={class:"dialog-footer"},Ge={key:0},Je={class:"evidence-images"},Le=Re({__name:"CreditReports",setup(He){var K,Y;const C=Ee(),S=k(!1),Q=k([]),B=k([]),X=k([]),A=k(!1),x=k(!1),$=k(!1),s=k(null),O=k([]),oe=k(),c=M({status:"",behaviorTypeId:null,keyword:"",current:1,size:10}),y=M({current:1,size:10,total:0}),i=M({userId:(K=C.userInfo)==null?void 0:K.id,behaviorTypeId:null,title:"",description:"",location:"",involvedPersons:[],evidenceFiles:[]}),w=M({reviewerId:(Y=C.userInfo)==null?void 0:Y.id,status:"APPROVED",scoreAwarded:0,reviewComment:""}),se=ae(()=>"/api/files/upload"),re=ae(()=>{var o;return{businessType:"EVIDENCE",userId:((o=C.userInfo)==null?void 0:o.id)||1}}),ne=o=>{const e=o.type.startsWith("image/"),g=o.size/1024/1024<10;return e?g?!0:(_.error("图片大小不能超过 10MB!"),!1):(_.error("只能上传图片文件!"),!1)},ie=o=>{o.code===200?(i.evidenceFiles.push(o.data.fileUrl),_.success("图片上传成功")):_.error(o.message||"上传失败")},ue=o=>{const e=O.value.findIndex(g=>g.uid===o.uid);e>-1&&i.evidenceFiles.splice(e,1)},D=async()=>{var o;S.value=!0;try{const e={current:y.current,size:y.size,status:c.status,behaviorTypeId:c.behaviorTypeId,keyword:c.keyword};C.isAdmin||(e.userId=(o=C.userInfo)==null?void 0:o.id);const g=await R.get("/credit-report/list",{params:e});Q.value=g.data.records||[],y.total=g.data.total||0}catch{_.error("加载数据失败")}finally{S.value=!1}},de=async()=>{try{const o=await R.get("/credit-behavior-type/active");B.value=o.data||[]}catch{_.error("加载行为类型失败")}},pe=async()=>{try{const o=await R.get("/user/list",{params:{size:1e3}});X.value=(o.data.records||[]).filter(e=>e.role!=="ADMIN")}catch{_.error("加载用户列表失败")}},ve=()=>{y.current=1,D()},me=()=>{c.status="",c.behaviorTypeId=null,c.keyword="",y.current=1,D()},ce=o=>{y.size=o,D()},fe=o=>{y.current=o,D()},_e=async()=>{try{const o={...i,involvedPersons:Array.isArray(i.involvedPersons)?i.involvedPersons.join("、"):i.involvedPersons};await R.post("/credit-report/submit",o),_.success("提交成功"),A.value=!1,i.behaviorTypeId=null,i.title="",i.description="",i.location="",i.involvedPersons=[],i.evidenceFiles=[],O.value=[],D()}catch{_.error("提交失败")}},be=o=>{s.value=o,w.status="APPROVED",w.scoreAwarded=0,w.reviewComment="",x.value=!0},ye=async()=>{try{if(!s.value)return;await R.put(`/credit-report/${s.value.id}/review`,w),_.success("审核完成"),x.value=!1,D()}catch{_.error("审核失败")}},we=async o=>{var e;try{await Te.confirm("确定要撤回这个上报吗？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),await R.put(`/credit-report/${o.id}/withdraw?userId=${(e=C.userInfo)==null?void 0:e.id}`),_.success("撤回成功"),D()}catch(g){g!=="cancel"&&_.error("撤回失败")}},ge=o=>{s.value=o,$.value=!0},W=o=>({PENDING:"warning",APPROVED:"success",REJECTED:"danger",WITHDRAWN:"info"})[o]||"info",G=o=>({PENDING:"待审核",APPROVED:"已通过",REJECTED:"已拒绝",WITHDRAWN:"已撤回"})[o]||"未知",J=o=>o?new Date(o).toLocaleString("zh-CN"):"";return Ae(()=>{D(),de(),pe()}),(o,e)=>{const g=u("el-icon"),V=u("el-button"),T=u("el-option"),F=u("el-select"),f=u("el-form-item"),z=u("el-input"),L=u("el-form"),E=u("el-table-column"),H=u("el-tag"),Ve=u("el-table"),ke=u("el-pagination"),j=u("el-card"),Ce=u("el-upload"),q=u("el-dialog"),d=u("el-descriptions-item"),Z=u("el-image"),ee=u("el-descriptions"),le=u("el-radio"),De=u("el-radio-group"),Ie=u("el-input-number"),Pe=xe("loading");return n(),P("div",Ue,[l(j,null,{header:t(()=>[m("div",he,[e[20]||(e[20]=m("span",null,"信用行为上报管理",-1)),N(C).isAdmin?b("",!0):(n(),p(V,{key:0,type:"primary",onClick:e[0]||(e[0]=a=>A.value=!0)},{default:t(()=>[l(g,null,{default:t(()=>[l(N(te))]),_:1}),e[19]||(e[19]=r(" 提交上报 "))]),_:1,__:[19]}))])]),default:t(()=>[m("div",Fe,[l(L,{inline:!0,model:c,class:"demo-form-inline"},{default:t(()=>[l(f,{label:"状态"},{default:t(()=>[l(F,{modelValue:c.status,"onUpdate:modelValue":e[1]||(e[1]=a=>c.status=a),placeholder:"请选择状态",clearable:""},{default:t(()=>[l(T,{label:"待审核",value:"PENDING"}),l(T,{label:"已通过",value:"APPROVED"}),l(T,{label:"已拒绝",value:"REJECTED"}),l(T,{label:"已撤回",value:"WITHDRAWN"})]),_:1},8,["modelValue"])]),_:1}),l(f,{label:"行为类型"},{default:t(()=>[l(F,{modelValue:c.behaviorTypeId,"onUpdate:modelValue":e[2]||(e[2]=a=>c.behaviorTypeId=a),placeholder:"请选择行为类型",clearable:""},{default:t(()=>[(n(!0),P(U,null,h(B.value,a=>(n(),p(T,{key:a.id,label:a.name,value:a.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),l(f,{label:"关键词"},{default:t(()=>[l(z,{modelValue:c.keyword,"onUpdate:modelValue":e[3]||(e[3]=a=>c.keyword=a),placeholder:"请输入标题或描述",clearable:""},null,8,["modelValue"])]),_:1}),l(f,null,{default:t(()=>[l(V,{type:"primary",onClick:ve},{default:t(()=>e[21]||(e[21]=[r("搜索")])),_:1,__:[21]}),l(V,{onClick:me},{default:t(()=>e[22]||(e[22]=[r("重置")])),_:1,__:[22]})]),_:1})]),_:1},8,["model"])]),ze((n(),p(Ve,{data:Q.value,style:{width:"100%"}},{default:t(()=>[l(E,{prop:"title",label:"标题",width:"200"}),l(E,{prop:"behaviorType",label:"行为类型",width:"120"}),l(E,{prop:"reportTime",label:"上报时间",width:"160"},{default:t(a=>[r(v(J(a.row.reportTime)),1)]),_:1}),l(E,{prop:"status",label:"状态",width:"100"},{default:t(a=>[l(H,{type:W(a.row.status)},{default:t(()=>[r(v(G(a.row.status)),1)]),_:2},1032,["type"])]),_:1}),l(E,{prop:"scoreAwarded",label:"得分",width:"80"}),l(E,{prop:"reviewComment",label:"审核意见","show-overflow-tooltip":""}),l(E,{label:"操作",width:"200"},{default:t(a=>[l(V,{size:"small",onClick:I=>ge(a.row)},{default:t(()=>e[23]||(e[23]=[r("查看")])),_:2,__:[23]},1032,["onClick"]),N(C).isAdmin&&a.row.status==="PENDING"?(n(),p(V,{key:0,size:"small",type:"primary",onClick:I=>be(a.row)},{default:t(()=>e[24]||(e[24]=[r(" 审核 ")])),_:2,__:[24]},1032,["onClick"])):b("",!0),!N(C).isAdmin&&a.row.status==="PENDING"?(n(),p(V,{key:1,size:"small",type:"danger",onClick:I=>we(a.row)},{default:t(()=>e[25]||(e[25]=[r(" 撤回 ")])),_:2,__:[25]},1032,["onClick"])):b("",!0)]),_:1})]),_:1},8,["data"])),[[Pe,S.value]]),m("div",Me,[l(ke,{"current-page":y.current,"onUpdate:currentPage":e[4]||(e[4]=a=>y.current=a),"page-size":y.size,"onUpdate:pageSize":e[5]||(e[5]=a=>y.size=a),"page-sizes":[10,20,50,100],total:y.total,layout:"total, sizes, prev, pager, next, jumper",onSizeChange:ce,onCurrentChange:fe},null,8,["current-page","page-size","total"])])]),_:1}),l(q,{modelValue:A.value,"onUpdate:modelValue":e[12]||(e[12]=a=>A.value=a),title:"提交信用行为上报",width:"600px"},{footer:t(()=>[m("span",Se,[l(V,{onClick:e[11]||(e[11]=a=>A.value=!1)},{default:t(()=>e[27]||(e[27]=[r("取消")])),_:1,__:[27]}),l(V,{type:"primary",onClick:_e},{default:t(()=>e[28]||(e[28]=[r("提交")])),_:1,__:[28]})])]),default:t(()=>[l(L,{model:i,"label-width":"100px"},{default:t(()=>[l(f,{label:"行为类型"},{default:t(()=>[l(F,{modelValue:i.behaviorTypeId,"onUpdate:modelValue":e[6]||(e[6]=a=>i.behaviorTypeId=a),placeholder:"请选择行为类型",style:{width:"100%"}},{default:t(()=>[(n(!0),P(U,null,h(B.value,a=>(n(),p(T,{key:a.id,label:a.name,value:a.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),l(f,{label:"标题"},{default:t(()=>[l(z,{modelValue:i.title,"onUpdate:modelValue":e[7]||(e[7]=a=>i.title=a),placeholder:"请输入上报标题"},null,8,["modelValue"])]),_:1}),l(f,{label:"描述"},{default:t(()=>[l(z,{modelValue:i.description,"onUpdate:modelValue":e[8]||(e[8]=a=>i.description=a),type:"textarea",rows:4,placeholder:"请详细描述行为情况"},null,8,["modelValue"])]),_:1}),l(f,{label:"发生地点"},{default:t(()=>[l(z,{modelValue:i.location,"onUpdate:modelValue":e[9]||(e[9]=a=>i.location=a),placeholder:"请输入发生地点"},null,8,["modelValue"])]),_:1}),l(f,{label:"涉及人员"},{default:t(()=>[l(F,{modelValue:i.involvedPersons,"onUpdate:modelValue":e[10]||(e[10]=a=>i.involvedPersons=a),multiple:"",placeholder:"请选择涉及人员",style:{width:"100%"},"collapse-tags":"","collapse-tags-tooltip":""},{default:t(()=>[(n(!0),P(U,null,h(X.value,a=>(n(),p(T,{key:a.id,label:a.realName,value:a.realName},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),l(f,{label:"证据图片"},{default:t(()=>[l(Ce,{ref_key:"uploadRef",ref:oe,action:se.value,data:re.value,"before-upload":ne,"on-success":ie,"on-remove":ue,"file-list":O.value,"list-type":"picture-card",accept:"image/*",limit:5},{default:t(()=>[l(g,null,{default:t(()=>[l(N(te))]),_:1})]),_:1},8,["action","data","file-list"]),e[26]||(e[26]=m("div",{class:"upload-tip"},"支持jpg、png、gif格式，最多上传5张图片，每张不超过10MB",-1))]),_:1,__:[26]})]),_:1},8,["model"])]),_:1},8,["modelValue"]),l(q,{modelValue:x.value,"onUpdate:modelValue":e[17]||(e[17]=a=>x.value=a),title:"审核上报",width:"800px"},{footer:t(()=>[m("span",We,[l(V,{onClick:e[16]||(e[16]=a=>x.value=!1)},{default:t(()=>e[33]||(e[33]=[r("取消")])),_:1,__:[33]}),l(V,{type:"primary",onClick:ye},{default:t(()=>e[34]||(e[34]=[r("提交审核")])),_:1,__:[34]})])]),default:t(()=>[s.value?(n(),P("div",Be,[l(j,{class:"review-report-card"},{header:t(()=>e[29]||(e[29]=[m("div",{class:"card-header"},[m("span",null,"上报内容")],-1)])),default:t(()=>[l(ee,{column:2,border:""},{default:t(()=>[l(d,{label:"标题"},{default:t(()=>[r(v(s.value.title),1)]),_:1}),l(d,{label:"行为类型"},{default:t(()=>[r(v(s.value.behaviorType),1)]),_:1}),l(d,{label:"上报时间"},{default:t(()=>[r(v(J(s.value.reportTime)),1)]),_:1}),l(d,{label:"状态"},{default:t(()=>[l(H,{type:W(s.value.status)},{default:t(()=>[r(v(G(s.value.status)),1)]),_:1},8,["type"])]),_:1}),s.value.location?(n(),p(d,{key:0,label:"发生地点"},{default:t(()=>[r(v(s.value.location),1)]),_:1})):b("",!0),s.value.involvedPersons?(n(),p(d,{key:1,label:"涉及人员"},{default:t(()=>[r(v(s.value.involvedPersons),1)]),_:1})):b("",!0),l(d,{label:"描述",span:2},{default:t(()=>[r(v(s.value.description),1)]),_:1}),s.value.evidenceFiles&&s.value.evidenceFiles.length>0?(n(),p(d,{key:2,label:"证据图片",span:2},{default:t(()=>[m("div",$e,[(n(!0),P(U,null,h(s.value.evidenceFiles,(a,I)=>(n(),p(Z,{key:I,src:a,"preview-src-list":s.value.evidenceFiles,"initial-index":I,fit:"cover",class:"evidence-image"},null,8,["src","preview-src-list","initial-index"]))),128))])]),_:1})):b("",!0)]),_:1})]),_:1})])):b("",!0),m("div",Oe,[l(j,null,{header:t(()=>e[30]||(e[30]=[m("div",{class:"card-header"},[m("span",null,"审核操作")],-1)])),default:t(()=>[l(L,{model:w,"label-width":"100px"},{default:t(()=>[l(f,{label:"审核结果"},{default:t(()=>[l(De,{modelValue:w.status,"onUpdate:modelValue":e[13]||(e[13]=a=>w.status=a)},{default:t(()=>[l(le,{label:"APPROVED"},{default:t(()=>e[31]||(e[31]=[r("通过")])),_:1,__:[31]}),l(le,{label:"REJECTED"},{default:t(()=>e[32]||(e[32]=[r("拒绝")])),_:1,__:[32]})]),_:1},8,["modelValue"])]),_:1}),w.status==="APPROVED"?(n(),p(f,{key:0,label:"得分"},{default:t(()=>[l(Ie,{modelValue:w.scoreAwarded,"onUpdate:modelValue":e[14]||(e[14]=a=>w.scoreAwarded=a),min:-999,max:999},null,8,["modelValue"])]),_:1})):b("",!0),l(f,{label:"审核意见"},{default:t(()=>[l(z,{modelValue:w.reviewComment,"onUpdate:modelValue":e[15]||(e[15]=a=>w.reviewComment=a),type:"textarea",rows:3,placeholder:"请填写审核意见"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1})])]),_:1},8,["modelValue"]),l(q,{modelValue:$.value,"onUpdate:modelValue":e[18]||(e[18]=a=>$.value=a),title:"上报详情",width:"600px"},{default:t(()=>[s.value?(n(),P("div",Ge,[l(ee,{column:2,border:""},{default:t(()=>[l(d,{label:"标题"},{default:t(()=>[r(v(s.value.title),1)]),_:1}),l(d,{label:"行为类型"},{default:t(()=>[r(v(s.value.behaviorType),1)]),_:1}),l(d,{label:"上报时间"},{default:t(()=>[r(v(J(s.value.reportTime)),1)]),_:1}),l(d,{label:"状态"},{default:t(()=>[l(H,{type:W(s.value.status)},{default:t(()=>[r(v(G(s.value.status)),1)]),_:1},8,["type"])]),_:1}),s.value.location?(n(),p(d,{key:0,label:"发生地点"},{default:t(()=>[r(v(s.value.location),1)]),_:1})):b("",!0),s.value.involvedPersons?(n(),p(d,{key:1,label:"涉及人员"},{default:t(()=>[r(v(s.value.involvedPersons),1)]),_:1})):b("",!0),l(d,{label:"描述",span:2},{default:t(()=>[r(v(s.value.description),1)]),_:1}),s.value.evidenceFiles&&s.value.evidenceFiles.length>0?(n(),p(d,{key:2,label:"证据图片",span:2},{default:t(()=>[m("div",Je,[(n(!0),P(U,null,h(s.value.evidenceFiles,(a,I)=>(n(),p(Z,{key:I,src:a,"preview-src-list":s.value.evidenceFiles,"initial-index":I,fit:"cover",class:"evidence-image"},null,8,["src","preview-src-list","initial-index"]))),128))])]),_:1})):b("",!0),s.value.reviewComment?(n(),p(d,{key:3,label:"审核意见",span:2},{default:t(()=>[r(v(s.value.reviewComment),1)]),_:1})):b("",!0)]),_:1})])):b("",!0)]),_:1},8,["modelValue"])])}}});const Ke=Ne(Le,[["__scopeId","data-v-fcaf77a0"]]);export{Ke as default};
