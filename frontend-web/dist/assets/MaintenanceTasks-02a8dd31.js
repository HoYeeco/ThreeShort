import{E as v,q as V,I as F,T as Q,C as $,U as j,z as R}from"./element-a02f8ecb.js";import{r as S}from"./index-9f97b358.js";import{x as H,r as d,k as J,z as O,Q as e,I as s,ag as u,aq as W,y as B,A as t,u as y,M as p,O as r,J as K,H as X,C as Y}from"./vendor-0e940c15.js";import{_ as Z}from"./_plugin-vue_export-helper-c27b6911.js";const ee={class:"maintenance-tasks"},te={class:"quick-actions"},se={class:"action-header"},ae={class:"action-content"},le={class:"action-header"},oe={class:"action-content"},ne={class:"status-item"},re={class:"status-icon success"},ie={class:"status-item"},de={class:"status-icon info"},ue={class:"status-info"},ce={class:"status-item"},_e={class:"status-icon warning"},pe={class:"status-info"},fe={class:"card-header"},ve={class:"stat-item"},me={class:"stat-number"},ge={class:"stat-item"},we={class:"stat-number"},ye={class:"stat-item"},he={class:"stat-number"},Ce={class:"stat-item"},Se={class:"stat-number"},ke={class:"pagination-wrapper"},be=H({__name:"MaintenanceTasks",setup(xe){const c=d({scoreGeneration:!1,recalculateCredit:!1}),G=d("周一 02:00"),k=d("暂无记录"),E=d([]),m=d({}),b=d(!1),T=d(0),_=d({page:1,size:20,period:""}),g=d([{time:"2024-01-15 02:00:00",task:"信用分数计算",status:"SUCCESS",message:"成功处理10个用户的评分记录"},{time:"2024-01-14 03:00:00",task:"信用等级重算",status:"SUCCESS",message:"重新计算完成，更新5个用户等级"}]),L=async()=>{try{await R.confirm("确定要手动执行信用分数计算吗？这将为所有用户生成当前周期的评分记录。","确认操作",{confirmButtonText:"确定",cancelButtonText:"取消",type:"info"}),c.value.scoreGeneration=!0,await S.post("/system/tasks/execute/score-generation"),v.success("信用分数计算执行成功！"),g.value.unshift({time:new Date().toLocaleString(),task:"信用分数计算",status:"SUCCESS",message:"手动执行成功"}),k.value="刚刚"}catch(l){l!=="cancel"&&(v.error(l.message||"执行失败"),g.value.unshift({time:new Date().toLocaleString(),task:"信用分数计算",status:"FAILED",message:l.message||"执行失败"}))}finally{c.value.scoreGeneration=!1}},U=async()=>{try{await R.confirm("确定要重新计算所有用户的信用等级吗？这可能需要一些时间。","确认操作",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),c.value.recalculateCredit=!0,await S.post("/system/tasks/execute/recalculate-credit"),v.success("信用等级重算执行成功！"),g.value.unshift({time:new Date().toLocaleString(),task:"信用等级重算",status:"SUCCESS",message:"手动执行成功"}),k.value="刚刚"}catch(l){l!=="cancel"&&(v.error(l.message||"执行失败"),g.value.unshift({time:new Date().toLocaleString(),task:"信用等级重算",status:"FAILED",message:l.message||"执行失败"}))}finally{c.value.recalculateCredit=!1}},h=async()=>{try{b.value=!0;const l=await S.get("/system/tasks/score-records/statistics");m.value=l.data||{};const a=await S.get("/system/tasks/score-records",{params:_.value});E.value=a.data.records||[],T.value=a.data.total||0}catch(l){v.error(l.message||"加载评分记录失败")}finally{b.value=!1}},I=l=>l>=90?"success":l>=70?"primary":l>=60?"warning":"danger",M=l=>{v.info(`查看用户 ${l.userName} 的评分记录详情`)},P=l=>{_.value.size=l,_.value.page=1,h()},N=l=>{_.value.page=l,h()};return J(()=>{h()}),(l,a)=>{const w=u("el-icon"),C=u("el-button"),f=u("el-card"),i=u("el-col"),x=u("el-row"),n=u("el-table-column"),z=u("el-tag"),D=u("el-table"),q=u("el-pagination"),A=W("loading");return B(),O("div",ee,[e(f,{class:"header-card"},{header:s(()=>a[2]||(a[2]=[t("div",{class:"card-header"},[t("h2",null,"定时任务管理"),t("p",null,"管理系统定时任务和手动同步操作")],-1)])),default:s(()=>[t("div",te,[e(x,{gutter:20},{default:s(()=>[e(i,{span:12},{default:s(()=>[e(f,{class:"action-card"},{header:s(()=>[t("div",se,[e(w,null,{default:s(()=>[e(y(V))]),_:1}),a[3]||(a[3]=t("span",null,"信用分数计算",-1))])]),default:s(()=>[t("div",ae,[a[4]||(a[4]=t("p",null,"手动触发信用分数计算和评分记录生成",-1)),e(C,{type:"primary",loading:c.value.scoreGeneration,onClick:L},{default:s(()=>[p(r(c.value.scoreGeneration?"执行中...":"立即同步"),1)]),_:1},8,["loading"])])]),_:1})]),_:1}),e(i,{span:12},{default:s(()=>[e(f,{class:"action-card"},{header:s(()=>[t("div",le,[e(w,null,{default:s(()=>[e(y(F))]),_:1}),a[5]||(a[5]=t("span",null,"信用等级重算",-1))])]),default:s(()=>[t("div",oe,[a[6]||(a[6]=t("p",null,"重新计算所有用户的信用等级",-1)),e(C,{type:"success",loading:c.value.recalculateCredit,onClick:U},{default:s(()=>[p(r(c.value.recalculateCredit?"执行中...":"立即重算"),1)]),_:1},8,["loading"])])]),_:1})]),_:1})]),_:1})])]),_:1}),e(f,{class:"status-card"},{header:s(()=>a[7]||(a[7]=[t("h3",null,"任务状态概览",-1)])),default:s(()=>[e(x,{gutter:20},{default:s(()=>[e(i,{span:8},{default:s(()=>[t("div",ne,[t("div",re,[e(w,null,{default:s(()=>[e(y(Q))]),_:1})]),a[8]||(a[8]=t("div",{class:"status-info"},[t("h4",null,"系统任务"),t("p",null,"2个定时任务正在运行")],-1))])]),_:1}),e(i,{span:8},{default:s(()=>[t("div",ie,[t("div",de,[e(w,null,{default:s(()=>[e(y($))]),_:1})]),t("div",ue,[a[9]||(a[9]=t("h4",null,"下次执行",-1)),t("p",null,r(G.value),1)])])]),_:1}),e(i,{span:8},{default:s(()=>[t("div",ce,[t("div",_e,[e(w,null,{default:s(()=>[e(y(j))]),_:1})]),t("div",pe,[a[10]||(a[10]=t("h4",null,"最近执行",-1)),t("p",null,r(k.value),1)])])]),_:1})]),_:1})]),_:1}),e(f,{class:"records-card"},{header:s(()=>[t("div",fe,[a[12]||(a[12]=t("h3",null,"批量生成评分记录",-1)),e(C,{type:"primary",onClick:h},{default:s(()=>a[11]||(a[11]=[p("刷新记录")])),_:1,__:[11]})])]),default:s(()=>[e(x,{gutter:20,class:"stats-row"},{default:s(()=>[e(i,{span:6},{default:s(()=>[t("div",ve,[t("div",me,r(m.value.totalRecords||0),1),a[13]||(a[13]=t("div",{class:"stat-label"},"总评分记录",-1))])]),_:1}),e(i,{span:6},{default:s(()=>[t("div",ge,[t("div",we,r(m.value.thisWeekRecords||0),1),a[14]||(a[14]=t("div",{class:"stat-label"},"本周记录",-1))])]),_:1}),e(i,{span:6},{default:s(()=>[t("div",ye,[t("div",he,r(m.value.totalRewardPoints||0),1),a[15]||(a[15]=t("div",{class:"stat-label"},"总奖励积分",-1))])]),_:1}),e(i,{span:6},{default:s(()=>[t("div",Ce,[t("div",Se,r(m.value.latestPeriod||"-"),1),a[16]||(a[16]=t("div",{class:"stat-label"},"最新周期",-1))])]),_:1})]),_:1}),K((B(),X(D,{data:E.value,style:{width:"100%"}},{default:s(()=>[e(n,{prop:"userId",label:"用户ID",width:"80"}),e(n,{prop:"userName",label:"用户姓名",width:"120"}),e(n,{prop:"scorePeriod",label:"评分周期",width:"120"}),e(n,{prop:"periodScore",label:"周期分数",width:"100",align:"center"},{default:s(o=>[e(z,{type:I(o.row.periodScore)},{default:s(()=>[p(r(o.row.periodScore),1)]),_:2},1032,["type"])]),_:1}),e(n,{prop:"rewardPointsGained",label:"获得奖励积分",width:"120",align:"center"},{default:s(o=>[t("span",{class:Y(o.row.rewardPointsGained>0?"reward-positive":"reward-zero")},r(o.row.rewardPointsGained),3)]),_:1}),e(n,{prop:"calculationTime",label:"计算时间",width:"160"}),e(n,{prop:"status",label:"状态",width:"100"},{default:s(o=>[e(z,{type:"success"},{default:s(()=>[p(r(o.row.status),1)]),_:2},1024)]),_:1}),e(n,{label:"操作",width:"120"},{default:s(o=>[e(C,{size:"small",onClick:ze=>M(o.row)},{default:s(()=>a[17]||(a[17]=[p("查看详情")])),_:2,__:[17]},1032,["onClick"])]),_:1})]),_:1},8,["data"])),[[A,b.value]]),t("div",ke,[e(q,{"current-page":_.value.page,"onUpdate:currentPage":a[0]||(a[0]=o=>_.value.page=o),"page-size":_.value.size,"onUpdate:pageSize":a[1]||(a[1]=o=>_.value.size=o),"page-sizes":[10,20,50],total:T.value,layout:"total, sizes, prev, pager, next, jumper",onSizeChange:P,onCurrentChange:N},null,8,["current-page","page-size","total"])])]),_:1}),e(f,{class:"log-card"},{header:s(()=>a[18]||(a[18]=[t("h3",null,"最近执行记录",-1)])),default:s(()=>[e(D,{data:g.value,style:{width:"100%"}},{default:s(()=>[e(n,{prop:"time",label:"执行时间",width:"180"}),e(n,{prop:"task",label:"任务名称"}),e(n,{prop:"status",label:"状态",width:"100"},{default:s(o=>[e(z,{type:o.row.status==="SUCCESS"?"success":"danger"},{default:s(()=>[p(r(o.row.status==="SUCCESS"?"成功":"失败"),1)]),_:2},1032,["type"])]),_:1}),e(n,{prop:"message",label:"执行结果"})]),_:1},8,["data"])]),_:1})])}}});const Be=Z(be,[["__scopeId","data-v-3754695c"]]);export{Be as default};
