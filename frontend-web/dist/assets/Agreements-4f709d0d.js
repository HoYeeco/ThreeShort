import{x as Ae,r as _,X as be,c as Ce,k as Ie,z as h,Q as s,I as t,ag as m,y as d,A as l,u as p,O as c,P as J,a4 as Y,a5 as Ee,M as i,H as T,L as y,n as Me,C as Ne,V as K}from"./vendor-0e940c15.js";import{E as v,K as Re,L as De,d as Z,v as xe,G as ze,M as Ue,b as ee,z as te}from"./element-a02f8ecb.js";import{u as $e,r as V}from"./index-9f97b358.js";import{_ as Se}from"./_plugin-vue_export-helper-c27b6911.js";const Be={class:"agreements-container"},Le={class:"card-header"},qe={class:"progress-content"},Pe={class:"progress-stats"},Xe={class:"stat-item"},Oe={class:"stat-value"},Fe={class:"stat-item"},Ke={class:"stat-value"},He={class:"stat-item"},je={class:"stat-value"},Ge={class:"stat-item"},Qe={class:"stat-value"},We={class:"card-header"},Je={class:"ai-chat-content"},Ye={class:"message-content"},Ze={class:"message-text"},et={class:"message-time"},tt={class:"chat-input"},st={class:"card-header"},at={class:"header-actions"},lt={class:"agreements-list"},ot=["onClick"],nt={class:"agreement-header"},it={class:"agreement-title"},rt={class:"learning-status"},dt={class:"agreement-meta"},ut={class:"agreement-order"},ct={class:"agreement-summary"},mt={class:"agreement-actions"},pt={key:0,class:"agreement-detail"},vt={class:"agreement-info"},_t={class:"agreement-content"},ft={key:0,class:"text-content"},gt=["innerHTML"],yt={key:1,class:"video-content"},wt=["src"],ht={class:"video-description"},Tt={class:"dialog-footer"},kt={key:0,class:"upload-success"},Vt={class:"dialog-footer"},At=Ae({__name:"Agreements",setup(bt){const w=$e(),A=_([]),b=_({totalAgreements:0,viewedAgreements:0,completionRate:0,questionCount:0,lastStudyTime:null}),U=_([{type:"assistant",content:"您好！我是社区公约智能助手。请您具体描述遇到的问题，我会根据社区公约为您提供相应的解答。",timestamp:new Date}]),E=_(""),$=_(!1),S=_(),B=_(!1),r=_(null),q=_(!1),M=_(!1),k=_(!1),P=_(!1),R=_(!1),D=_(),X=_(!1),u=be({title:"",content:"",contentType:"TEXT",videoPath:"",orderNum:1,isActive:!0}),se={title:[{required:!0,message:"请输入公约标题",trigger:"blur"},{min:2,max:200,message:"标题长度在 2 到 200 个字符",trigger:"blur"}],content:[{required:!0,message:"请输入公约内容",trigger:"blur"}],contentType:[{required:!0,message:"请选择内容类型",trigger:"change"}]},ae=Ce(()=>{const a=b.value.completionRate;return a<30?"#f56c6c":a<70?"#e6a23c":"#67c23a"}),O=async()=>{try{const a=w.hasRole("ADMIN")||w.hasRole("MAINTAINER")?"/agreements/admin/list":"/agreements/list",e=await V.get(a);A.value=e.data,await le()}catch{v.error("获取公约列表失败")}},le=async()=>{if(!(!w.isLoggedIn||A.value.length===0))try{const a=A.value.map(async n=>{try{const f=await V.get(`/agreements/${n.id}/status`);return{id:n.id,isViewed:f.data.isViewed,isCompleted:f.data.isCompleted}}catch{return{id:n.id,isViewed:!1,isCompleted:!1}}}),e=await Promise.all(a);A.value.forEach(n=>{const f=e.find(C=>C.id===n.id);f&&(n.isViewed=f.isViewed,n.isCompleted=f.isCompleted)})}catch(a){console.error("获取学习状态失败:",a)}},x=async()=>{try{const a=await V.get("/agreements/learning/stats");b.value=a.data}catch(a){console.error("获取学习统计失败:",a)}},H=async()=>{if(!E.value.trim())return;const a=E.value.trim();U.value.push({type:"user",content:a,timestamp:new Date}),E.value="",$.value=!0;try{const e=await V.post("/agreements/ask",{question:a,sessionId:"web-session-"+Date.now()});U.value.push({type:"assistant",content:e.data.answer,timestamp:new Date(e.data.timestamp)})}catch{U.value.push({type:"assistant",content:"抱歉，暂时无法回答您的问题，请稍后重试。",timestamp:new Date}),v.error("AI问答失败")}finally{$.value=!1,Me(()=>{S.value&&(S.value.scrollTop=S.value.scrollHeight)})}},j=async a=>{try{const e=await V.get(`/agreements/${a.id}`),n=e.data.agreement;n.isCompleted=e.data.isCompleted,r.value=n,B.value=!0;const f=A.value.find(C=>C.id===a.id);f&&(f.isViewed=!0,f.isCompleted=e.data.isCompleted),await x()}catch{v.error("获取公约详情失败")}},oe=async a=>{q.value=!0;try{await V.post(`/agreements/${a}/complete`),v.success("已标记完成学习"),r.value&&(r.value.isCompleted=!0);const e=A.value.find(n=>n.id===a);e&&(e.isCompleted=!0,e.isViewed=!0),await x()}catch{v.error("标记失败")}finally{q.value=!1}},ne=a=>{k.value=!0,Object.assign(u,a),M.value=!0},ie=async()=>{D.value&&await D.value.validate(async a=>{if(a){P.value=!0;try{const e=k.value?`/agreements/admin/${u.id}`:"/agreements/admin/create",n=k.value?"put":"post";await V[n](e,u),v.success(k.value?"更新成功":"创建成功"),M.value=!1,me(),await O(),await x()}catch{v.error(k.value?"更新失败":"创建失败")}finally{P.value=!1}}})},re=async a=>{try{await te.confirm("确定要删除这个公约吗？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),await V.delete(`/agreements/admin/${a}`),v.success("删除成功"),await O(),await x()}catch(e){e!=="cancel"&&v.error("删除失败")}},de=a=>{const e=a.type.startsWith("video/"),n=a.size/1024/1024<10;return e?n?(R.value=!0,!0):(v.error("上传文件大小不能超过 10MB!"),!1):(v.error("只能上传视频文件!"),!1)},ue=a=>{R.value=!1,a.code===200?(u.videoPath=a.data.fileUrl,v.success("视频上传成功")):v.error(a.message||"上传失败")},ce=()=>{R.value=!1,v.error("上传失败，请重试")},me=()=>{const a=k.value;k.value=!1,Object.assign(u,{title:a?"":"邻里和睦相处公约",content:"",contentType:"TEXT",videoPath:"",orderNum:1,isActive:!0}),D.value&&D.value.resetFields()},pe=a=>a.length>100?a.substring(0,100)+"...":a,ve=a=>a.replace(/\n/g,"<br>"),_e=a=>new Date(a).toLocaleTimeString(),fe=a=>new Date(a).toLocaleString(),ge=async()=>{try{await te.confirm("此操作将重新构建AI知识库，可能需要一些时间。确定要继续吗？","初始化知识库",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),X.value=!0,await V.post("/agreements/admin/init-knowledge"),v.success("知识库初始化成功！AI问答功能已更新。")}catch(a){a!=="cancel"&&v.error("知识库初始化失败")}finally{X.value=!1}};return Ie(async()=>{await O(),await x()}),(a,e)=>{var W;const n=m("el-icon"),f=m("el-progress"),C=m("el-card"),g=m("el-button"),F=m("el-input"),I=m("el-tag"),L=m("el-descriptions-item"),ye=m("el-descriptions"),G=m("el-dialog"),N=m("el-form-item"),Q=m("el-radio"),we=m("el-radio-group"),he=m("el-upload"),Te=m("el-input-number"),ke=m("el-switch"),Ve=m("el-form");return d(),h("div",Be,[s(C,{class:"progress-card",shadow:"hover"},{header:t(()=>[l("div",Le,[s(n,null,{default:t(()=>[s(p(Re))]),_:1}),e[12]||(e[12]=l("span",null,"学习进度",-1))])]),default:t(()=>[l("div",qe,[l("div",Pe,[l("div",Xe,[l("div",Oe,c(b.value.completionRate)+"%",1),e[13]||(e[13]=l("div",{class:"stat-label"},"完成率",-1))]),l("div",Fe,[l("div",Ke,c(b.value.viewedAgreements),1),e[14]||(e[14]=l("div",{class:"stat-label"},"已学习",-1))]),l("div",He,[l("div",je,c(b.value.totalAgreements),1),e[15]||(e[15]=l("div",{class:"stat-label"},"总数",-1))]),l("div",Ge,[l("div",Qe,c(b.value.questionCount),1),e[16]||(e[16]=l("div",{class:"stat-label"},"问答次数",-1))])]),s(f,{percentage:b.value.completionRate,color:ae.value,"stroke-width":8,class:"progress-bar"},null,8,["percentage","color"])])]),_:1}),s(C,{class:"ai-chat-card",shadow:"hover"},{header:t(()=>[l("div",We,[s(n,null,{default:t(()=>[s(p(De))]),_:1}),e[17]||(e[17]=l("span",null,"AI智能问答",-1))])]),default:t(()=>[l("div",Je,[l("div",{class:"chat-messages",ref_key:"chatMessagesRef",ref:S},[(d(!0),h(J,null,Y(U.value,(o,z)=>(d(),h("div",{key:z,class:Ne(["message",o.type])},[l("div",Ye,[l("div",Ze,c(o.content),1),l("div",et,c(_e(o.timestamp)),1)])],2))),128))],512),l("div",tt,[s(F,{modelValue:E.value,"onUpdate:modelValue":e[0]||(e[0]=o=>E.value=o),placeholder:"请输入您的问题，我会根据社区公约为您解答...",onKeyup:Ee(H,["enter"]),disabled:$.value},{append:t(()=>[s(g,{type:"primary",onClick:H,loading:$.value,disabled:!E.value.trim()},{default:t(()=>e[18]||(e[18]=[i(" 发送 ")])),_:1,__:[18]},8,["loading","disabled"])]),_:1},8,["modelValue","disabled"])])])]),_:1}),s(C,{class:"agreements-list-card",shadow:"hover"},{header:t(()=>[l("div",st,[s(n,null,{default:t(()=>[s(p(Z))]),_:1}),e[21]||(e[21]=l("span",null,"社区公约",-1)),l("div",at,[p(w).hasRole("ADMIN")?(d(),T(g,{key:0,type:"info",onClick:ge,loading:X.value},{default:t(()=>[s(n,null,{default:t(()=>[s(p(xe))]),_:1}),e[19]||(e[19]=i(" 初始化AI知识库 "))]),_:1,__:[19]},8,["loading"])):y("",!0),p(w).hasRole("ADMIN")||p(w).hasRole("MAINTAINER")?(d(),T(g,{key:1,type:"primary",onClick:e[1]||(e[1]=o=>M.value=!0)},{default:t(()=>[s(n,null,{default:t(()=>[s(p(ze))]),_:1}),e[20]||(e[20]=i(" 添加公约 "))]),_:1,__:[20]})):y("",!0)])])]),default:t(()=>[l("div",lt,[(d(!0),h(J,null,Y(A.value,o=>(d(),h("div",{key:o.id,class:"agreement-item",onClick:z=>j(o)},[l("div",nt,[l("div",it,[s(n,null,{default:t(()=>[s(p(Z))]),_:1}),i(" "+c(o.title)+" ",1),l("div",rt,[o.isCompleted?(d(),T(I,{key:0,type:"success",size:"small",effect:"dark"},{default:t(()=>[s(n,null,{default:t(()=>[s(p(ee))]),_:1}),e[22]||(e[22]=i(" 已完成学习 "))]),_:1,__:[22]})):o.isViewed?(d(),T(I,{key:1,type:"warning",size:"small",effect:"plain"},{default:t(()=>e[23]||(e[23]=[i(" 已查看 ")])),_:1,__:[23]})):(d(),T(I,{key:2,type:"info",size:"small",effect:"plain"},{default:t(()=>e[24]||(e[24]=[i(" 未学习 ")])),_:1,__:[24]}))])]),l("div",dt,[s(I,{type:o.contentType==="TEXT"?"info":"warning",size:"small"},{default:t(()=>[i(c(o.contentType==="TEXT"?"文本":"视频"),1)]),_:2},1032,["type"]),l("span",ut,"序号: "+c(o.orderNum),1)])]),l("div",ct,c(pe(o.content)),1),l("div",mt,[s(g,{type:"primary",size:"small",onClick:K(z=>j(o),["stop"])},{default:t(()=>e[25]||(e[25]=[i(" 查看详情 ")])),_:2,__:[25]},1032,["onClick"]),p(w).hasRole("ADMIN")||p(w).hasRole("MAINTAINER")?(d(),T(g,{key:0,type:"warning",size:"small",onClick:K(z=>ne(o),["stop"])},{default:t(()=>e[26]||(e[26]=[i(" 编辑 ")])),_:2,__:[26]},1032,["onClick"])):y("",!0),p(w).hasRole("ADMIN")||p(w).hasRole("MAINTAINER")?(d(),T(g,{key:1,type:"danger",size:"small",onClick:K(z=>re(o.id),["stop"])},{default:t(()=>e[27]||(e[27]=[i(" 删除 ")])),_:2,__:[27]},1032,["onClick"])):y("",!0)])],8,ot))),128))])]),_:1}),s(G,{modelValue:B.value,"onUpdate:modelValue":e[4]||(e[4]=o=>B.value=o),title:(W=r.value)==null?void 0:W.title,width:"60%",class:"agreement-detail-dialog"},{footer:t(()=>[l("div",Tt,[s(g,{onClick:e[2]||(e[2]=o=>B.value=!1)},{default:t(()=>e[29]||(e[29]=[i("关闭")])),_:1,__:[29]}),r.value&&!r.value.isCompleted?(d(),T(g,{key:0,type:"primary",onClick:e[3]||(e[3]=o=>oe(r.value.id)),disabled:q.value},{default:t(()=>e[30]||(e[30]=[i(" 标记已完成学习 ")])),_:1,__:[30]},8,["disabled"])):y("",!0),r.value&&r.value.isCompleted?(d(),T(I,{key:1,type:"success",size:"large"},{default:t(()=>e[31]||(e[31]=[i(" 已完成学习 ")])),_:1,__:[31]})):y("",!0)])]),default:t(()=>[r.value?(d(),h("div",pt,[l("div",vt,[s(ye,{column:2,border:""},{default:t(()=>[s(L,{label:"内容类型"},{default:t(()=>[s(I,{type:r.value.contentType==="TEXT"?"info":"warning"},{default:t(()=>[i(c(r.value.contentType==="TEXT"?"文本内容":"视频内容"),1)]),_:1},8,["type"])]),_:1}),s(L,{label:"排序号"},{default:t(()=>[i(c(r.value.orderNum),1)]),_:1}),s(L,{label:"状态"},{default:t(()=>[s(I,{type:r.value.isActive?"success":"danger"},{default:t(()=>[i(c(r.value.isActive?"启用":"禁用"),1)]),_:1},8,["type"])]),_:1}),s(L,{label:"创建时间"},{default:t(()=>[i(c(fe(r.value.createdTime)),1)]),_:1})]),_:1})]),l("div",_t,[e[28]||(e[28]=l("h4",null,"公约内容：",-1)),r.value.contentType==="TEXT"?(d(),h("div",ft,[l("div",{innerHTML:ve(r.value.content)},null,8,gt)])):r.value.contentType==="VIDEO"?(d(),h("div",yt,[r.value.videoPath?(d(),h("video",{key:0,src:r.value.videoPath,controls:"",width:"100%"},null,8,wt)):y("",!0),l("div",ht,[l("p",null,c(r.value.content),1)])])):y("",!0)])])):y("",!0)]),_:1},8,["modelValue","title"]),s(G,{modelValue:M.value,"onUpdate:modelValue":e[11]||(e[11]=o=>M.value=o),title:k.value?"编辑公约":"创建公约",width:"50%"},{footer:t(()=>[l("div",Vt,[s(g,{onClick:e[10]||(e[10]=o=>M.value=!1)},{default:t(()=>e[36]||(e[36]=[i("取消")])),_:1,__:[36]}),s(g,{type:"primary",onClick:ie,loading:P.value},{default:t(()=>[i(c(k.value?"更新":"创建"),1)]),_:1},8,["loading"])])]),default:t(()=>[s(Ve,{ref_key:"agreementFormRef",ref:D,model:u,rules:se,"label-width":"100px"},{default:t(()=>[s(N,{label:"公约标题",prop:"title"},{default:t(()=>[s(F,{modelValue:u.title,"onUpdate:modelValue":e[5]||(e[5]=o=>u.title=o),placeholder:"请输入公约标题"},null,8,["modelValue"])]),_:1}),s(N,{label:"内容类型",prop:"contentType"},{default:t(()=>[s(we,{modelValue:u.contentType,"onUpdate:modelValue":e[6]||(e[6]=o=>u.contentType=o)},{default:t(()=>[s(Q,{value:"TEXT"},{default:t(()=>e[32]||(e[32]=[i("文本内容")])),_:1,__:[32]}),s(Q,{value:"VIDEO"},{default:t(()=>e[33]||(e[33]=[i("视频内容")])),_:1,__:[33]})]),_:1},8,["modelValue"])]),_:1}),s(N,{label:"公约内容",prop:"content"},{default:t(()=>[s(F,{modelValue:u.content,"onUpdate:modelValue":e[7]||(e[7]=o=>u.content=o),type:"textarea",rows:8,placeholder:"请输入公约内容"},null,8,["modelValue"])]),_:1}),u.contentType==="VIDEO"?(d(),T(N,{key:0,label:"视频文件",prop:"videoPath"},{default:t(()=>[s(he,{class:"video-uploader",action:"/api/files/upload",data:{businessType:"AGREEMENT_VIDEO",userId:1},"show-file-list":!1,"on-success":ue,"on-error":ce,"before-upload":de,accept:"video/*"},{default:t(()=>[s(g,{type:"primary",loading:R.value},{default:t(()=>[s(n,null,{default:t(()=>[s(p(Ue))]),_:1}),i(" "+c(R.value?"上传中...":"选择视频文件"),1)]),_:1},8,["loading"]),u.videoPath?(d(),h("div",kt,[s(n,null,{default:t(()=>[s(p(ee))]),_:1}),e[34]||(e[34]=i(" 文件上传成功 "))])):y("",!0)]),_:1}),e[35]||(e[35]=l("div",{class:"upload-tip"}," 支持 mp4、mov、avi 格式，文件大小不超过 10MB ",-1))]),_:1,__:[35]})):y("",!0),s(N,{label:"排序号",prop:"orderNum"},{default:t(()=>[s(Te,{modelValue:u.orderNum,"onUpdate:modelValue":e[8]||(e[8]=o=>u.orderNum=o),min:1,max:999,placeholder:"排序号"},null,8,["modelValue"])]),_:1}),s(N,{label:"状态"},{default:t(()=>[s(ke,{modelValue:u.isActive,"onUpdate:modelValue":e[9]||(e[9]=o=>u.isActive=o),"active-text":"启用","inactive-text":"禁用"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"])])}}});const Nt=Se(At,[["__scopeId","data-v-5e3e6b85"]]);export{Nt as default};
