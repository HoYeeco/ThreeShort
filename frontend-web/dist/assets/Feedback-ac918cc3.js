import{E as m,N as De,G as Fe}from"./element-a02f8ecb.js";import{r as U,u as Le}from"./index-3d03330f.js";import{x as Te,r as c,X,c as Y,k as Ge,z as E,Q as t,I as a,ag as d,aq as Ae,y as r,A as h,M as i,P as G,a4 as A,u as k,J as Ue,H as f,O as g,L as C}from"./vendor-0e940c15.js";import{_ as Me}from"./_plugin-vue_export-helper-c27b6911.js";const Pe=o=>U.post("/feedback",o),ze=o=>U.get("/feedback/list",{params:o}),Be=o=>U.get("/feedback/my",{params:o}),ue=o=>U.get(`/feedback/${o}`),qe=(o,R)=>U.put(`/feedback/${o}/handle`,R);var O=(o=>(o.SUGGESTION="SUGGESTION",o.COMPLAINT="COMPLAINT",o.LEARNING_FEEDBACK="LEARNING_FEEDBACK",o.OTHER="OTHER",o))(O||{}),w=(o=>(o.PENDING="PENDING",o.PROCESSING="PROCESSING",o.RESOLVED="RESOLVED",o.CLOSED="CLOSED",o))(w||{});const $e=[{value:"SUGGESTION",label:"建议"},{value:"COMPLAINT",label:"投诉"},{value:"LEARNING_FEEDBACK",label:"学习反馈"},{value:"OTHER",label:"其他"}],He=[{value:"PENDING",label:"待处理"},{value:"PROCESSING",label:"处理中"},{value:"RESOLVED",label:"已解决"},{value:"CLOSED",label:"已关闭"}],Ke={class:"feedback-container"},Qe={class:"card-header"},je={class:"pagination-container"},Je={class:"dialog-footer"},We={key:0,class:"feedback-detail"},Xe={class:"content-text"},Ye={class:"attachment-list"},Ze={class:"reply-text"},el={key:0,class:"handle-form"},ll={class:"dialog-footer"},tl=Te({__name:"Feedback",setup(o){const R=Le(),q=c(!1),$=c(!1),H=c(!1),x=c(!1),S=c(!1),I=c(!1),Z=c([]),ee=c(0),u=c(null),M=c([]),D=c([]),F=c(),L=c(),p=X({page:1,size:10,keyword:"",type:void 0,status:void 0}),_=X({type:O.SUGGESTION,title:"",content:"",attachmentFileIds:[]}),y=X({status:w.PROCESSING,handlerReply:""}),K=$e,Q=He,re={type:[{required:!0,message:"请选择反馈类型",trigger:"change"}],title:[{required:!0,message:"请输入反馈标题",trigger:"blur"},{max:200,message:"标题长度不能超过200个字符",trigger:"blur"}],content:[{required:!0,message:"请输入反馈内容",trigger:"blur"},{max:2e3,message:"内容长度不能超过2000个字符",trigger:"blur"}]},de={status:[{required:!0,message:"请选择处理状态",trigger:"change"}],handlerReply:[{required:!0,message:"请输入处理回复",trigger:"blur"},{max:1e3,message:"回复长度不能超过1000个字符",trigger:"blur"}]},ie=Y(()=>I.value?"处理反馈建议":"查看反馈建议"),pe=Y(()=>"/api/files/upload"),ce=Y(()=>({businessType:"FEEDBACK",userId:1})),le=s=>{const e=K.find(n=>n.value===s);return(e==null?void 0:e.label)||s},te=s=>{const e=Q.find(n=>n.value===s);return(e==null?void 0:e.label)||s},ae=s=>({[O.SUGGESTION]:"success",[O.COMPLAINT]:"danger",[O.LEARNING_FEEDBACK]:"warning",[O.OTHER]:""})[s],se=s=>({[w.PENDING]:"info",[w.PROCESSING]:"warning",[w.RESOLVED]:"success",[w.CLOSED]:""})[s],T=async()=>{q.value=!0;try{let s;R.hasRole("ADMIN")||R.hasRole("MAINTAINER")?s=await ze(p):s=await Be(p),Z.value=s.data.records,ee.value=s.data.total}catch{m.error("加载反馈列表失败")}finally{q.value=!1}},j=()=>{p.page=1,T()},me=()=>{Object.assign(p,{page:1,size:10,keyword:"",type:void 0,status:void 0}),T()},fe=async s=>{try{const e=await ue(s.id);u.value=e.data,I.value=!1,S.value=!0}catch{m.error("获取反馈详情失败")}},ve=async s=>{try{const e=await ue(s.id);u.value=e.data,I.value=!0,y.status=w.PROCESSING,y.handlerReply=s.handlerReply||"",S.value=!0}catch{m.error("获取反馈详情失败")}},_e=s=>{const e=s.type.startsWith("image/"),n=s.size/1024/1024<10;return e?n?!0:(m.error("上传文件大小不能超过 10MB!"),!1):(m.error("只能上传图片文件!"),!1)},ge=(s,e)=>{if(s.code===200)D.value.push(s.data),m.success("上传成功");else{m.error(s.message||"上传失败");const n=M.value.findIndex(V=>V.uid===e.uid);n>-1&&M.value.splice(n,1)}},ye=s=>{const e=D.value.findIndex(n=>n.originalName===s.name);e>-1&&D.value.splice(e,1)},be=async()=>{if(F.value)try{await F.value.validate(),$.value=!0,_.attachmentFileIds=D.value.map(s=>s.fileId),await Pe(_),m.success("反馈提交成功"),x.value=!1,T()}catch(s){if(s.fields)return;m.error(s.message||"提交失败")}finally{$.value=!1}},Ee=async()=>{if(!(!L.value||!u.value))try{await L.value.validate(),H.value=!0,await qe(u.value.id,y),m.success("处理成功"),S.value=!1,T()}catch(s){if(s.fields)return;m.error(s.message||"处理失败")}finally{H.value=!1}},he=()=>{F.value&&F.value.resetFields(),M.value=[],D.value=[]},ke=()=>{u.value=null,I.value=!1,L.value&&L.value.resetFields()};return Ge(()=>{T()}),(s,e)=>{const n=d("el-button"),V=d("el-input"),v=d("el-form-item"),P=d("el-option"),z=d("el-select"),J=d("el-form"),N=d("el-table-column"),B=d("el-tag"),oe=d("el-icon"),Ne=d("el-table"),Ce=d("el-pagination"),we=d("el-card"),Re=d("el-upload"),ne=d("el-dialog"),b=d("el-descriptions-item"),Se=d("el-image"),Ie=d("el-descriptions"),Ve=d("el-divider"),Oe=Ae("loading");return r(),E("div",Ke,[t(we,null,{header:a(()=>[h("div",Qe,[e[16]||(e[16]=h("span",null,"反馈建议管理",-1)),t(n,{type:"primary",onClick:e[0]||(e[0]=l=>x.value=!0)},{default:a(()=>e[15]||(e[15]=[i(" 提交反馈 ")])),_:1,__:[15]})])]),default:a(()=>[t(J,{model:p,inline:!0,class:"query-form"},{default:a(()=>[t(v,{label:"关键词"},{default:a(()=>[t(V,{modelValue:p.keyword,"onUpdate:modelValue":e[1]||(e[1]=l=>p.keyword=l),placeholder:"标题/内容",clearable:"",style:{width:"200px"}},null,8,["modelValue"])]),_:1}),t(v,{label:"反馈类型"},{default:a(()=>[t(z,{modelValue:p.type,"onUpdate:modelValue":e[2]||(e[2]=l=>p.type=l),placeholder:"请选择",clearable:"",style:{width:"150px"}},{default:a(()=>[(r(!0),E(G,null,A(k(K),l=>(r(),f(P,{key:l.value,label:l.label,value:l.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),t(v,{label:"状态"},{default:a(()=>[t(z,{modelValue:p.status,"onUpdate:modelValue":e[3]||(e[3]=l=>p.status=l),placeholder:"请选择",clearable:"",style:{width:"120px"}},{default:a(()=>[(r(!0),E(G,null,A(k(Q),l=>(r(),f(P,{key:l.value,label:l.label,value:l.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),t(v,null,{default:a(()=>[t(n,{type:"primary",onClick:j},{default:a(()=>e[17]||(e[17]=[i("查询")])),_:1,__:[17]}),t(n,{onClick:me},{default:a(()=>e[18]||(e[18]=[i("重置")])),_:1,__:[18]})]),_:1})]),_:1},8,["model"]),Ue((r(),f(Ne,{data:Z.value,border:"",stripe:""},{default:a(()=>[t(N,{prop:"id",label:"ID",width:"80"}),t(N,{prop:"title",label:"标题","min-width":"200","show-overflow-tooltip":""}),t(N,{prop:"type",label:"类型",width:"120"},{default:a(({row:l})=>[t(B,{type:ae(l.type)},{default:a(()=>[i(g(le(l.type)),1)]),_:2},1032,["type"])]),_:1}),t(N,{prop:"status",label:"状态",width:"100"},{default:a(({row:l})=>[t(B,{type:se(l.status)},{default:a(()=>[i(g(te(l.status)),1)]),_:2},1032,["type"])]),_:1}),t(N,{prop:"attachmentFiles",label:"附件",width:"80"},{default:a(({row:l})=>[l.attachmentFileList&&l.attachmentFileList.length>0?(r(),f(oe,{key:0,color:"#409EFF"},{default:a(()=>[t(k(De))]),_:1})):C("",!0)]),_:1}),t(N,{prop:"createdTime",label:"提交时间",width:"180"}),t(N,{label:"操作",width:"200",fixed:"right"},{default:a(({row:l})=>[t(n,{type:"primary",size:"small",onClick:W=>fe(l)},{default:a(()=>e[19]||(e[19]=[i(" 查看 ")])),_:2,__:[19]},1032,["onClick"]),k(R).hasRole("ADMIN")||k(R).hasRole("MAINTAINER")?(r(),f(n,{key:0,type:"warning",size:"small",onClick:W=>ve(l),disabled:l.status==="CLOSED"},{default:a(()=>e[20]||(e[20]=[i(" 处理 ")])),_:2,__:[20]},1032,["onClick","disabled"])):C("",!0)]),_:1})]),_:1},8,["data"])),[[Oe,q.value]]),h("div",je,[t(Ce,{"current-page":p.page,"onUpdate:currentPage":e[4]||(e[4]=l=>p.page=l),"page-size":p.size,"onUpdate:pageSize":e[5]||(e[5]=l=>p.size=l),total:ee.value,"page-sizes":[10,20,50,100],layout:"total, sizes, prev, pager, next, jumper",onSizeChange:j,onCurrentChange:j},null,8,["current-page","page-size","total"])])]),_:1}),t(ne,{modelValue:x.value,"onUpdate:modelValue":e[10]||(e[10]=l=>x.value=l),title:"提交反馈建议",width:"600px",onClose:he},{footer:a(()=>[h("span",Je,[t(n,{onClick:e[9]||(e[9]=l=>x.value=!1)},{default:a(()=>e[21]||(e[21]=[i("取消")])),_:1,__:[21]}),t(n,{type:"primary",loading:$.value,onClick:be},{default:a(()=>e[22]||(e[22]=[i(" 提交 ")])),_:1,__:[22]},8,["loading"])])]),default:a(()=>[t(J,{ref_key:"submitFormRef",ref:F,model:_,rules:re,"label-width":"100px"},{default:a(()=>[t(v,{label:"反馈类型",prop:"type"},{default:a(()=>[t(z,{modelValue:_.type,"onUpdate:modelValue":e[6]||(e[6]=l=>_.type=l),placeholder:"请选择反馈类型",style:{width:"100%"}},{default:a(()=>[(r(!0),E(G,null,A(k(K),l=>(r(),f(P,{key:l.value,label:l.label,value:l.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),t(v,{label:"反馈标题",prop:"title"},{default:a(()=>[t(V,{modelValue:_.title,"onUpdate:modelValue":e[7]||(e[7]=l=>_.title=l),placeholder:"请输入反馈标题",maxlength:"200"},null,8,["modelValue"])]),_:1}),t(v,{label:"反馈内容",prop:"content"},{default:a(()=>[t(V,{modelValue:_.content,"onUpdate:modelValue":e[8]||(e[8]=l=>_.content=l),type:"textarea",placeholder:"请详细描述您的反馈内容",rows:5,maxlength:"2000","show-word-limit":""},null,8,["modelValue"])]),_:1}),t(v,{label:"附件上传"},{default:a(()=>[t(Re,{ref:"uploadRef",action:pe.value,data:ce.value,"before-upload":_e,"on-success":ge,"on-remove":ye,"file-list":M.value,"list-type":"picture-card",accept:"image/*",multiple:"",limit:5},{default:a(()=>[t(oe,null,{default:a(()=>[t(k(Fe))]),_:1})]),_:1},8,["action","data","file-list"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),t(ne,{modelValue:S.value,"onUpdate:modelValue":e[14]||(e[14]=l=>S.value=l),title:ie.value,width:"800px",onClose:ke},{footer:a(()=>[h("span",ll,[t(n,{onClick:e[13]||(e[13]=l=>S.value=!1)},{default:a(()=>e[24]||(e[24]=[i("取消")])),_:1,__:[24]}),I.value?(r(),f(n,{key:0,type:"primary",loading:H.value,onClick:Ee},{default:a(()=>e[25]||(e[25]=[i(" 确定处理 ")])),_:1,__:[25]},8,["loading"])):C("",!0)])]),default:a(()=>[u.value?(r(),E("div",We,[t(Ie,{column:2,border:""},{default:a(()=>{var l;return[t(b,{label:"反馈类型"},{default:a(()=>[t(B,{type:ae(u.value.type)},{default:a(()=>[i(g(le(u.value.type)),1)]),_:1},8,["type"])]),_:1}),t(b,{label:"状态"},{default:a(()=>[t(B,{type:se(u.value.status)},{default:a(()=>[i(g(te(u.value.status)),1)]),_:1},8,["type"])]),_:1}),t(b,{label:"标题",span:2},{default:a(()=>[i(g(u.value.title),1)]),_:1}),t(b,{label:"反馈内容",span:2},{default:a(()=>[h("div",Xe,g(u.value.content),1)]),_:1}),(l=u.value.attachmentFileList)!=null&&l.length?(r(),f(b,{key:0,label:"附件",span:2},{default:a(()=>[h("div",Ye,[(r(!0),E(G,null,A(u.value.attachmentFileList,(W,xe)=>(r(),f(Se,{key:xe,src:W,"preview-src-list":u.value.attachmentFileList,fit:"cover",class:"attachment-image"},null,8,["src","preview-src-list"]))),128))])]),_:1})):C("",!0),t(b,{label:"提交时间"},{default:a(()=>[i(g(u.value.createdTime),1)]),_:1}),t(b,{label:"处理时间"},{default:a(()=>[i(g(u.value.handleTime||"暂未处理"),1)]),_:1}),u.value.handlerReply?(r(),f(b,{key:1,label:"处理回复",span:2},{default:a(()=>[h("div",Ze,g(u.value.handlerReply),1)]),_:1})):C("",!0)]}),_:1}),I.value?(r(),E("div",el,[t(Ve,{"content-position":"left"},{default:a(()=>e[23]||(e[23]=[i("处理反馈")])),_:1,__:[23]}),t(J,{ref_key:"handleFormRef",ref:L,model:y,rules:de,"label-width":"100px"},{default:a(()=>[t(v,{label:"处理状态",prop:"status"},{default:a(()=>[t(z,{modelValue:y.status,"onUpdate:modelValue":e[11]||(e[11]=l=>y.status=l),placeholder:"请选择处理状态",style:{width:"200px"}},{default:a(()=>[(r(!0),E(G,null,A(k(Q).filter(l=>l.value!=="PENDING"),l=>(r(),f(P,{key:l.value,label:l.label,value:l.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),t(v,{label:"处理回复",prop:"handlerReply"},{default:a(()=>[t(V,{modelValue:y.handlerReply,"onUpdate:modelValue":e[12]||(e[12]=l=>y.handlerReply=l),type:"textarea",placeholder:"请输入处理回复",rows:4,maxlength:"1000","show-word-limit":""},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])])):C("",!0)])):C("",!0)]),_:1},8,["modelValue","title"])])}}});const ul=Me(tl,[["__scopeId","data-v-fef17f7a"]]);export{ul as default};
