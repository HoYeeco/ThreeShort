import{x as Se,r as v,c as $,k as $e,z as B,A as n,O as r,u as _,Q as l,I as a,L as D,H as M,aA as Be,ag as m,y as A,M as p,P as Me,a4 as Te}from"./vendor-0e940c15.js";import{E as f,k as oe,G as ne,e as Fe,H as Ne,I as Oe,z as je}from"./element-a02f8ecb.js";import{u as He,r as P}from"./index-3d03330f.js";import{_ as Ge}from"./_plugin-vue_export-helper-c27b6911.js";const We={class:"products-container"},Je={class:"page-header"},Ke={class:"header-left"},Xe={key:0,class:"user-points"},Ye={class:"header-right"},Ze={key:0,class:"products-grid"},el={class:"product-image"},ll=["src"],tl={class:"product-info"},al={class:"product-name"},ol={class:"product-desc"},nl={class:"product-price"},sl={class:"points"},il={class:"product-meta"},ul={class:"stock"},rl={class:"product-actions"},dl={class:"pagination"},cl={class:"dialog-footer"},vl={key:0,class:"exchange-dialog"},ml={class:"product-summary"},pl={class:"product-image-small"},fl=["src"],gl={class:"product-details"},_l={class:"price-info"},yl={class:"points"},bl={class:"total-points"},wl={class:"exchange-info"},kl={class:"dialog-footer"},Al={class:"dialog-footer"},se="/images/default-product.png",Vl=Se({__name:"Products",setup(xl){const y=He(),ie=Be(),N=v([]),c=v(null),b=v({name:"",category:"",minPoints:null,maxPoints:null,isActive:null}),V=v({current:1,size:12,total:0}),R=v(!1),I=v(!1),Q=v(!1),O=v(!1),j=v(!1),H=v(!1),h=v(null),w=v(null),S=v(),E=v([]),ue=v(),d=v({name:"",description:"",pointsRequired:1,stockQuantity:0,category:"",minEligibleLevel:"D",imageUrl:""}),k=v({quantity:1,remarks:""}),C=v({productId:null,productName:"",currentStock:0,newStock:0}),re={name:[{required:!0,message:"请输入商品名称",trigger:"blur"}],pointsRequired:[{required:!0,message:"请输入所需积分",trigger:"blur"}],stockQuantity:[{required:!0,message:"请输入库存数量",trigger:"blur"}],category:[{required:!0,message:"请选择商品分类",trigger:"change"}]},G=$(()=>w.value?w.value.pointsRequired*k.value.quantity:0),de=$(()=>{if(!w.value||!c.value)return 1;const t=w.value.stockQuantity,e=Math.floor(c.value.rewardPoints/w.value.pointsRequired);return Math.min(t,e,99)}),ce=$(()=>c.value&&c.value.rewardPoints>=G.value&&k.value.quantity>0),ve=$(()=>"/api/files/upload"),me=$(()=>{var t;return{businessType:"PRODUCT",userId:((t=y.userInfo)==null?void 0:t.id)||1}}),x=async()=>{try{const t={current:V.value.current,size:V.value.size,...b.value},e=await P.get("/product/list",{params:t});N.value=e.data.records||[],V.value.total=e.data.total||0}catch{f.error("加载商品列表失败")}},Z=async()=>{var t;if((t=y.userInfo)!=null&&t.id)try{const e=await P.get(`/user-credit-profile/current?userId=${y.userInfo.id}`);c.value=e.data}catch{f.error("加载用户信息失败")}},pe=()=>{b.value={name:"",category:"",minPoints:null,maxPoints:null,isActive:null},V.value.current=1,x()},fe=()=>{ie.push("/exchange-records")},ge=t=>{const e=t.type.startsWith("image/"),s=t.size/1024/1024<10;return e?s?!0:(f.error("上传文件大小不能超过 10MB!"),!1):(f.error("只能上传图片文件!"),!1)},_e=(t,e)=>{if(t.code===200)d.value.imageUrl=t.data.fileUrl,f.success("上传成功");else{f.error(t.message||"上传失败");const s=E.value.findIndex(u=>u.uid===e.uid);s>-1&&E.value.splice(s,1)}},ye=t=>{d.value.imageUrl=""},ee=()=>{d.value={name:"",description:"",pointsRequired:1,stockQuantity:0,category:"",minEligibleLevel:"D",imageUrl:""},E.value=[],S.value&&S.value.clearValidate()},be=()=>{h.value=null,ee(),R.value=!0},we=t=>{h.value=t,d.value={name:t.name,description:t.description,pointsRequired:t.pointsRequired,stockQuantity:t.stockQuantity,category:t.category,minEligibleLevel:W(t.eligibleLevels),imageUrl:t.imageUrl||""},t.imageUrl?E.value=[{name:"商品图片",url:t.imageUrl,uid:Date.now(),status:"success"}]:E.value=[],R.value=!0},ke=async()=>{if(S.value){try{await S.value.validate()}catch{f.error("请填写完整的商品信息");return}O.value=!0;try{h.value?(await P.put(`/product/${h.value.id}`,d.value),f.success("更新商品成功")):(await P.post("/product/create",d.value),f.success("创建商品成功")),R.value=!1,h.value=null,ee(),x()}catch{f.error(h.value?"更新商品失败":"创建商品失败")}finally{O.value=!1}}},Ae=async t=>{try{await je.confirm(`确定要删除商品"${t.name}"吗？`,"提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),await P.delete(`/product/${t.id}`),f.success("删除成功"),x()}catch(e){e!=="cancel"&&f.error("删除失败")}},Ve=async t=>{try{await P.put(`/product/${t.id}/toggle-status`),f.success("状态更新成功")}catch{f.error("状态更新失败"),t.isActive=!t.isActive}},xe=t=>{C.value={productId:t.id,productName:t.name,currentStock:t.stockQuantity,newStock:t.stockQuantity},Q.value=!0},Le=async()=>{H.value=!0;try{await P.put(`/product/${C.value.productId}/stock?quantity=${C.value.newStock}`),f.success("库存更新成功"),Q.value=!1,x()}catch{f.error("库存更新失败")}finally{H.value=!1}},he=t=>{w.value=t,k.value={quantity:1,remarks:""},I.value=!0},Ce=async()=>{var t;if(!(!w.value||!((t=y.userInfo)!=null&&t.id))){j.value=!0;try{const e={userId:y.userInfo.id,productId:w.value.id,quantity:k.value.quantity,remarks:k.value.remarks};await P.post("/product/exchange",e),f.success("兑换成功！"),I.value=!1,x(),Z()}catch{f.error("兑换失败")}finally{j.value=!1}}},W=t=>{if(!t||t.length===0)return"D";const e={D:1,C:2,B:3,A:4,AA:5,AAA:6};let s="AAA",u=6;for(const q of t){const i=e[q]||6;i<u&&(u=i,s=q)}return s},le=t=>{const e=["D","C","B","A","AA","AAA"],s=e.indexOf(t);return s>=0?e.slice(s):["D"]},Ue=t=>{if(!c.value)return!1;if(t.eligibleLevels&&t.eligibleLevels.length>0)return t.isActive&&t.stockQuantity>0&&c.value.rewardPoints>=t.pointsRequired&&t.eligibleLevels.includes(c.value.creditLevel);const e=t.minEligibleLevel||"D",s=le(e);return t.isActive&&t.stockQuantity>0&&c.value.rewardPoints>=t.pointsRequired&&s.includes(c.value.creditLevel)},Pe=t=>{if(!t.isActive)return"已下架";if(t.stockQuantity<=0)return"已售罄";if(!c.value)return"立即兑换";if(c.value.rewardPoints<t.pointsRequired)return"积分不足";let e=!0;if(t.eligibleLevels&&t.eligibleLevels.length>0)e=t.eligibleLevels.includes(c.value.creditLevel);else{const s=t.minEligibleLevel||"D";e=le(s).includes(c.value.creditLevel)}return e?"立即兑换":"等级不足"},te=t=>{let e="D";return t.eligibleLevels&&t.eligibleLevels.length>0?e=W(t.eligibleLevels):e=t.minEligibleLevel||"D",e==="AAA"?"success":e==="AA"||e==="A"?"primary":e==="B"||e==="C"?"warning":"info"},ae=t=>{let e="D";return t.eligibleLevels&&t.eligibleLevels.length>0?e=W(t.eligibleLevels):e=t.minEligibleLevel||"D",e==="D"?"全员可兑换":`${e}级及以上可兑换`},qe=t=>new Date(t).toLocaleString("zh-CN");return $e(()=>{x(),y.isAdmin||Z()}),(t,e)=>{const s=m("el-icon"),u=m("el-button"),q=m("el-input"),i=m("el-form-item"),g=m("el-option"),T=m("el-select"),z=m("el-input-number"),F=m("el-form"),J=m("el-card"),K=m("el-tag"),De=m("el-col"),Re=m("el-row"),U=m("el-table-column"),Ee=m("el-switch"),ze=m("el-table"),Ie=m("el-pagination"),Qe=m("el-upload"),X=m("el-dialog");return A(),B("div",We,[n("div",Je,[n("div",Ke,[n("h2",null,r(_(y).isAdmin?"商品管理":"积分商城"),1),!_(y).isAdmin&&c.value?(A(),B("div",Xe,[l(s,null,{default:a(()=>[l(_(oe))]),_:1}),n("span",null,"我的积分："+r(c.value.rewardPoints||0),1)])):D("",!0)]),n("div",Ye,[_(y).isAdmin?(A(),M(u,{key:0,type:"primary",onClick:be},{default:a(()=>[l(s,null,{default:a(()=>[l(_(ne))]),_:1}),e[22]||(e[22]=p(" 添加商品 "))]),_:1,__:[22]})):D("",!0),_(y).isAdmin?D("",!0):(A(),M(u,{key:1,type:"success",onClick:fe},{default:a(()=>[l(s,null,{default:a(()=>[l(_(Fe))]),_:1}),e[23]||(e[23]=p(" 兑换记录 "))]),_:1,__:[23]}))])]),l(J,{class:"filter-card",shadow:"never"},{default:a(()=>[l(F,{model:b.value,inline:""},{default:a(()=>[l(i,{label:"商品名称"},{default:a(()=>[l(q,{modelValue:b.value.name,"onUpdate:modelValue":e[0]||(e[0]=o=>b.value.name=o),placeholder:"请输入商品名称",clearable:"",style:{width:"200px"}},null,8,["modelValue"])]),_:1}),l(i,{label:"商品分类"},{default:a(()=>[l(T,{modelValue:b.value.category,"onUpdate:modelValue":e[1]||(e[1]=o=>b.value.category=o),placeholder:"请选择分类",clearable:"",style:{width:"150px"}},{default:a(()=>[l(g,{label:"生活用品",value:"生活用品"}),l(g,{label:"服务券",value:"服务券"}),l(g,{label:"荣誉奖品",value:"荣誉奖品"})]),_:1},8,["modelValue"])]),_:1}),l(i,{label:"积分范围"},{default:a(()=>[l(z,{modelValue:b.value.minPoints,"onUpdate:modelValue":e[2]||(e[2]=o=>b.value.minPoints=o),placeholder:"最小积分",min:0,style:{width:"120px"}},null,8,["modelValue"]),e[24]||(e[24]=n("span",{style:{margin:"0 10px"}},"-",-1)),l(z,{modelValue:b.value.maxPoints,"onUpdate:modelValue":e[3]||(e[3]=o=>b.value.maxPoints=o),placeholder:"最大积分",min:0,style:{width:"120px"}},null,8,["modelValue"])]),_:1,__:[24]}),_(y).isAdmin?(A(),M(i,{key:0,label:"状态"},{default:a(()=>[l(T,{modelValue:b.value.isActive,"onUpdate:modelValue":e[4]||(e[4]=o=>b.value.isActive=o),placeholder:"商品状态",clearable:"",style:{width:"120px"}},{default:a(()=>[l(g,{label:"启用",value:!0}),l(g,{label:"禁用",value:!1})]),_:1},8,["modelValue"])]),_:1})):D("",!0),l(i,null,{default:a(()=>[l(u,{type:"primary",onClick:x},{default:a(()=>[l(s,null,{default:a(()=>[l(_(Ne))]),_:1}),e[25]||(e[25]=p(" 搜索 "))]),_:1,__:[25]}),l(u,{onClick:pe},{default:a(()=>[l(s,null,{default:a(()=>[l(_(Oe))]),_:1}),e[26]||(e[26]=p(" 重置 "))]),_:1,__:[26]})]),_:1})]),_:1},8,["model"])]),_:1}),_(y).isAdmin?D("",!0):(A(),B("div",Ze,[l(Re,{gutter:20},{default:a(()=>[(A(!0),B(Me,null,Te(N.value,o=>(A(),M(De,{key:o.id,xs:24,sm:12,md:8,lg:6},{default:a(()=>[l(J,{class:"product-card",shadow:"hover"},{default:a(()=>[n("div",el,[n("img",{src:o.imageUrl||se,alt:"商品图片"},null,8,ll)]),n("div",tl,[n("h3",al,r(o.name),1),n("p",ol,r(o.description),1),n("div",nl,[l(s,null,{default:a(()=>[l(_(oe))]),_:1}),n("span",sl,r(o.pointsRequired),1),e[27]||(e[27]=n("span",{class:"unit"},"积分",-1))]),n("div",il,[l(K,{type:te(o),size:"small"},{default:a(()=>[p(r(ae(o)),1)]),_:2},1032,["type"]),n("span",ul,"库存："+r(o.stockQuantity),1)]),n("div",rl,[l(u,{type:"primary",onClick:L=>he(o),disabled:!Ue(o),style:{width:"100%"}},{default:a(()=>[p(r(Pe(o)),1)]),_:2},1032,["onClick","disabled"])])])]),_:2},1024)]),_:2},1024))),128))]),_:1})])),_(y).isAdmin?(A(),M(J,{key:1,class:"table-card"},{default:a(()=>[l(ze,{data:N.value,style:{width:"100%"},"row-key":"id"},{default:a(()=>[l(U,{prop:"name",label:"商品名称","min-width":"150"}),l(U,{prop:"category",label:"分类",width:"100"}),l(U,{prop:"pointsRequired",label:"所需积分",width:"100",align:"center"},{default:a(o=>[l(K,{type:"warning"},{default:a(()=>[p(r(o.row.pointsRequired),1)]),_:2},1024)]),_:1}),l(U,{prop:"stockQuantity",label:"库存",width:"80",align:"center"}),l(U,{label:"可兑换等级",width:"150"},{default:a(o=>[l(K,{type:te(o.row),size:"small"},{default:a(()=>[p(r(ae(o.row)),1)]),_:2},1032,["type"])]),_:1}),l(U,{prop:"isActive",label:"状态",width:"80",align:"center"},{default:a(o=>[l(Ee,{modelValue:o.row.isActive,"onUpdate:modelValue":L=>o.row.isActive=L,onChange:L=>Ve(o.row)},null,8,["modelValue","onUpdate:modelValue","onChange"])]),_:1}),l(U,{prop:"createdTime",label:"创建时间",width:"160"},{default:a(o=>[p(r(qe(o.row.createdTime)),1)]),_:1}),l(U,{label:"操作",width:"180",fixed:"right"},{default:a(o=>[l(u,{type:"primary",size:"small",onClick:L=>we(o.row)},{default:a(()=>e[28]||(e[28]=[p(" 编辑 ")])),_:2,__:[28]},1032,["onClick"]),l(u,{type:"warning",size:"small",onClick:L=>xe(o.row)},{default:a(()=>e[29]||(e[29]=[p(" 库存 ")])),_:2,__:[29]},1032,["onClick"]),l(u,{type:"danger",size:"small",onClick:L=>Ae(o.row)},{default:a(()=>e[30]||(e[30]=[p(" 删除 ")])),_:2,__:[30]},1032,["onClick"])]),_:1})]),_:1},8,["data"]),n("div",dl,[l(Ie,{"current-page":V.value.current,"onUpdate:currentPage":e[5]||(e[5]=o=>V.value.current=o),"page-size":V.value.size,"onUpdate:pageSize":e[6]||(e[6]=o=>V.value.size=o),"page-sizes":[10,20,50],total:V.value.total,layout:"total, sizes, prev, pager, next, jumper",onSizeChange:x,onCurrentChange:x},null,8,["current-page","page-size","total"])])]),_:1})):D("",!0),l(X,{modelValue:R.value,"onUpdate:modelValue":e[14]||(e[14]=o=>R.value=o),title:h.value?"编辑商品":"添加商品",width:"600px"},{footer:a(()=>[n("span",cl,[l(u,{onClick:e[13]||(e[13]=o=>R.value=!1)},{default:a(()=>e[33]||(e[33]=[p("取消")])),_:1,__:[33]}),l(u,{type:"primary",onClick:ke,loading:O.value},{default:a(()=>[p(r(h.value?"更新":"创建"),1)]),_:1},8,["loading"])])]),default:a(()=>[l(F,{model:d.value,rules:re,ref_key:"productFormRef",ref:S,"label-width":"120px"},{default:a(()=>[l(i,{label:"商品名称",prop:"name"},{default:a(()=>[l(q,{modelValue:d.value.name,"onUpdate:modelValue":e[7]||(e[7]=o=>d.value.name=o),placeholder:"请输入商品名称"},null,8,["modelValue"])]),_:1}),l(i,{label:"商品描述",prop:"description"},{default:a(()=>[l(q,{modelValue:d.value.description,"onUpdate:modelValue":e[8]||(e[8]=o=>d.value.description=o),type:"textarea",rows:3,placeholder:"请输入商品描述"},null,8,["modelValue"])]),_:1}),l(i,{label:"所需积分",prop:"pointsRequired"},{default:a(()=>[l(z,{modelValue:d.value.pointsRequired,"onUpdate:modelValue":e[9]||(e[9]=o=>d.value.pointsRequired=o),min:1,style:{width:"100%"}},null,8,["modelValue"])]),_:1}),l(i,{label:"库存数量",prop:"stockQuantity"},{default:a(()=>[l(z,{modelValue:d.value.stockQuantity,"onUpdate:modelValue":e[10]||(e[10]=o=>d.value.stockQuantity=o),min:0,style:{width:"100%"}},null,8,["modelValue"])]),_:1}),l(i,{label:"商品分类",prop:"category"},{default:a(()=>[l(T,{modelValue:d.value.category,"onUpdate:modelValue":e[11]||(e[11]=o=>d.value.category=o),placeholder:"请选择分类",style:{width:"100%"}},{default:a(()=>[l(g,{label:"生活用品",value:"生活用品"}),l(g,{label:"服务券",value:"服务券"}),l(g,{label:"荣誉奖品",value:"荣誉奖品"})]),_:1},8,["modelValue"])]),_:1}),l(i,{label:"最低兑换等级",prop:"minEligibleLevel"},{default:a(()=>[l(T,{modelValue:d.value.minEligibleLevel,"onUpdate:modelValue":e[12]||(e[12]=o=>d.value.minEligibleLevel=o),placeholder:"请选择最低兑换等级",style:{width:"100%"}},{default:a(()=>[l(g,{label:"D级（所有用户可兑换）",value:"D"}),l(g,{label:"C级（C级及以上可兑换）",value:"C"}),l(g,{label:"B级（B级及以上可兑换）",value:"B"}),l(g,{label:"A级（A级及以上可兑换）",value:"A"}),l(g,{label:"AA级（AA级及以上可兑换）",value:"AA"}),l(g,{label:"AAA级（仅AAA级可兑换）",value:"AAA"})]),_:1},8,["modelValue"]),e[31]||(e[31]=n("div",{class:"form-tip"},"选择最低兑换等级，该等级及更高等级的用户都可以兑换此商品",-1))]),_:1,__:[31]}),l(i,{label:"商品图片"},{default:a(()=>[l(Qe,{ref_key:"uploadRef",ref:ue,action:ve.value,data:me.value,"before-upload":ge,"on-success":_e,"on-remove":ye,"file-list":E.value,"list-type":"picture-card",accept:"image/*",limit:1},{default:a(()=>[l(s,null,{default:a(()=>[l(_(ne))]),_:1})]),_:1},8,["action","data","file-list"]),e[32]||(e[32]=n("div",{class:"upload-tip"},"支持jpg、png、gif格式，文件大小不超过10MB",-1))]),_:1,__:[32]})]),_:1},8,["model"])]),_:1},8,["modelValue","title"]),l(X,{modelValue:I.value,"onUpdate:modelValue":e[18]||(e[18]=o=>I.value=o),title:"积分兑换",width:"500px"},{footer:a(()=>[n("span",kl,[l(u,{onClick:e[17]||(e[17]=o=>I.value=!1)},{default:a(()=>e[35]||(e[35]=[p("取消")])),_:1,__:[35]}),l(u,{type:"primary",onClick:Ce,loading:j.value,disabled:!ce.value},{default:a(()=>e[36]||(e[36]=[p(" 确认兑换 ")])),_:1,__:[36]},8,["loading","disabled"])])]),default:a(()=>{var o,L;return[w.value?(A(),B("div",vl,[n("div",ml,[n("div",pl,[n("img",{src:w.value.imageUrl||se,alt:"商品图片"},null,8,fl)]),n("div",gl,[n("h3",null,r(w.value.name),1),n("p",null,r(w.value.description),1),n("div",_l,[n("span",yl,r(w.value.pointsRequired),1),e[34]||(e[34]=n("span",{class:"unit"},"积分/个",-1))])])]),l(F,{model:k.value,"label-width":"80px"},{default:a(()=>[l(i,{label:"兑换数量"},{default:a(()=>[l(z,{modelValue:k.value.quantity,"onUpdate:modelValue":e[15]||(e[15]=Y=>k.value.quantity=Y),min:1,max:de.value,style:{width:"100%"}},null,8,["modelValue","max"])]),_:1}),l(i,{label:"总积分"},{default:a(()=>[n("span",bl,r(G.value)+" 积分",1)]),_:1}),l(i,{label:"备注"},{default:a(()=>[l(q,{modelValue:k.value.remarks,"onUpdate:modelValue":e[16]||(e[16]=Y=>k.value.remarks=Y),placeholder:"请输入备注信息（可选）"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"]),n("div",wl,[n("p",null,"您当前积分："+r(((o=c.value)==null?void 0:o.rewardPoints)||0),1),n("p",null,"兑换后余额："+r((((L=c.value)==null?void 0:L.rewardPoints)||0)-G.value),1)])])):D("",!0)]}),_:1},8,["modelValue"]),l(X,{modelValue:Q.value,"onUpdate:modelValue":e[21]||(e[21]=o=>Q.value=o),title:"更新库存",width:"400px"},{footer:a(()=>[n("span",Al,[l(u,{onClick:e[20]||(e[20]=o=>Q.value=!1)},{default:a(()=>e[37]||(e[37]=[p("取消")])),_:1,__:[37]}),l(u,{type:"primary",onClick:Le,loading:H.value},{default:a(()=>e[38]||(e[38]=[p(" 更新 ")])),_:1,__:[38]},8,["loading"])])]),default:a(()=>[l(F,{model:C.value,"label-width":"80px"},{default:a(()=>[l(i,{label:"商品名称"},{default:a(()=>[n("span",null,r(C.value.productName),1)]),_:1}),l(i,{label:"当前库存"},{default:a(()=>[n("span",null,r(C.value.currentStock),1)]),_:1}),l(i,{label:"新库存",required:""},{default:a(()=>[l(z,{modelValue:C.value.newStock,"onUpdate:modelValue":e[19]||(e[19]=o=>C.value.newStock=o),min:0,style:{width:"100%"}},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])}}});const Pl=Ge(Vl,[["__scopeId","data-v-4452e789"]]);export{Pl as default};
